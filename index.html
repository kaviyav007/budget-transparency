<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicSpend Pro | Public Transparency Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --brand: #2563eb;
            --brand-soft: #eff6ff;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --slate-900: #0f172a;
            --slate-600: #475569;
            --slate-100: #f1f5f9;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; background-color: #f8fafc; color: var(--slate-900);
            scroll-behavior: smooth;
        }

        /* MODALS */
        .login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
        }
        .modal-content {
            background: white; margin: 10% auto; width: 90%; max-width: 500px; 
            border-radius: 20px; padding: 40px; position: relative;
        }
        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 2rem; cursor: pointer; }

        /* ENTRY MODAL - FIRST LOAD */
        #entryModal { display: block !important; }

        /* NAVIGATION */
        nav {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 1rem 5%; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--slate-100);
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-weight: 800; font-size: 1.4rem; color: var(--brand); letter-spacing: -0.5px; }
        .nav-links a { text-decoration: none; color: var(--slate-600); font-weight: 600; font-size: 0.9rem; margin-left: 24px; transition: 0.2s; }
        .nav-links a:hover { color: var(--brand); }
        .user-status { font-weight: 600; color: var(--brand); }
        .admin-badge { background: #fef3c7; color: var(--warning); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }

        /* HERO */
        .hero {
            padding: 120px 10% 160px; text-align: center;
            background: radial-gradient(circle at 50% 0%, #e0f2fe 0%, #f8fafc 100%);
        }
        .hero h1 { font-size: 4rem; font-weight: 800; margin-bottom: 1.5rem; line-height: 1.1; letter-spacing: -2px; }
        .hero p { font-size: 1.35rem; color: var(--slate-600); max-width: 800px; margin: 0 auto 3rem; line-height: 1.6; }
        .cta-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 16px 32px; border-radius: 14px; font-weight: 700; text-decoration: none; transition: 0.3s; cursor: pointer; border: none; font-size: 1rem; }
        .btn-primary { background: var(--brand); color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.3); }
        .btn-secondary { background: white; border: 2px solid var(--brand); color: var(--brand); }

        /* DASHBOARD */
        .dashboard-container {
            max-width: 1400px; margin: -100px auto 100px; padding: 0 20px;
            display: grid; grid-template-columns: 1.8fr 1fr; gap: 40px;
        }
        .card { 
            background: white; border-radius: 28px; padding: 40px; 
            border: 1px solid var(--slate-100); box-shadow: 0 10px 30px rgba(0,0,0,0.04); 
            position: relative;
        }
        .data-freshness { position: absolute; top: 20px; right: 20px; font-size: 0.75rem; color: var(--success); font-weight: 600; }

        /* STATS & CHARTS */
        .badge { display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; }
        .badge-blue { background: var(--brand-soft); color: var(--brand); }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-orange { background: #fef3c7; color: #92400e; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; text-align: center; border: 1px solid #f3e8ff; }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--brand); }
        .vote-demographics { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .demographic-chart { height: 300px; }

        /* SEARCH & TABLE */
        .search-container { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 14px 45px 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; }
        .search-icon { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--slate-600); }
        .download-btns { display: flex; gap: 10px; margin-top: 15px; }
        .download-btns button { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; cursor: pointer; font-weight: 600; }
        .ledger-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .ledger-table th, .ledger-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .ledger-table th { background: #f8fafc; font-weight: 700; color: var(--slate-900); }
        .ledger-table tr:hover { background: var(--brand-soft); }

        /* MAP */
        #project-map { height: 400px; border-radius: 16px; margin-top: 20px; }

        /* FORMS */
        .input-group { background: #f8fafc; padding: 22px; border-radius: 18px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .input-group label { display: flex; justify-content: space-between; font-weight: 700; font-size: 1rem; }
        input[type=range] { width: 100%; height: 8px; accent-color: var(--brand); margin: 18px 0 10px; cursor: pointer; }
        select, input[type="text"], input[type="email"], input[type="password"], textarea { 
            width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 8px 0; 
        }

        /* ADMIN */
        .admin-section { background: #fef7ff; border: 2px solid #e879f9; border-radius: 20px; padding: 30px; margin-bottom: 20px; }
        #adminDashboard { display: none; }

        /* CHATBOT */
        #chatbot { position: fixed; right: 18px; bottom: 18px; z-index: 3000; }
        #chatbotPanel { display: none; width: 320px; max-width: 85vw; height: 420px; background: white; border: 1px solid #e2e8f0; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-top: 10px; overflow: hidden; }

        /* SECTIONS */
        .how-it-works, .faq-section, .news-section { padding: 100px 10%; }
        .section-title { text-align: center; margin-bottom: 60px; }
        .section-title h2 { font-size: 2.5rem; font-weight: 800; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
        .step-card { padding: 30px; text-align: left; border-radius: 20px; background: #f8fafc; border: 1px solid #f1f5f9; }
        .step-num { width: 40px; height: 40px; background: var(--brand); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-bottom: 20px; }
        .accordion-item { background: white; margin-bottom: 15px; border-radius: 15px; border: 1px solid #e2e8f0; overflow: hidden; }
        .accordion-header { padding: 20px 25px; cursor: pointer; display: flex; justify-content: space-between; font-weight: 700; transition: 0.3s; }
        .accordion-header:hover { background: var(--brand-soft); }
        .accordion-content { padding: 0 25px 20px; color: var(--slate-600); font-size: 0.95rem; line-height: 1.6; max-height: 0; overflow: hidden; transition: 0.3s; }
        .accordion-content.active { max-height: 200px; padding: 25px 25px 20px; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .news-card { border-radius: 20px; overflow: hidden; border: 1px solid #f1f5f9; transition: 0.3s; position: relative; }
        .news-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .news-img { width: 100%; height: 180px; object-fit: cover; display: block; }
        .news-body { padding: 20px; }
        .report-issue { position: absolute; bottom: 10px; right: 10px; background: var(--danger); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

        /* RESPONSIVE */
        @media (max-width: 1000px) { 
            .dashboard-container { grid-template-columns: 1fr; } 
            .hero h1 { font-size: 2.8rem; }
            .vote-demographics { grid-template-columns: 1fr; }
        }
        footer { background: var(--slate-900); color: white; padding: 80px 10%; margin-top: 0; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 50px; }
        .footer-bottom { border-top: 1px solid #334155; margin-top: 60px; padding-top: 30px; font-size: 0.85rem; color: #94a3b8; text-align: center; }
    </style>
</head>
<body>

<!-- ENTRY MODAL - FIRST LOAD BLOCKER -->
<div id="entryModal" class="login-modal">
    <div class="modal-content">
        <h3>Choose Login Type</h3>
        <p style="color:var(--slate-600)">Select how you want to continue.</p>
        <div style="display:flex; gap:12px; margin-top:18px; flex-wrap:wrap;">
            <button class="btn btn-primary" style="flex:1" onclick="chooseEntry('user')">üë§ Continue as User</button>
            <button class="btn btn-secondary" style="flex:1" onclick="chooseEntry('admin')">üõ°Ô∏è Continue as Admin</button>
        </div>
        <div id="entryUserActions" style="margin-top:18px; display:none;">
            <button class="btn" style="width:100%; border:1px solid #e2e8f0; background:white;" onclick="enterAsGuest()">
                üëÅÔ∏è Browse as Guest (no vote)
            </button>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openLoginModal('user'); closeEntryModal();">
                üì± Login to Vote (OTP)
            </button>
        </div>
        <div id="entryAdminActions" style="margin-top:18px; display:none;">
            <button class="btn btn-primary" style="width:100%;" onclick="openLoginModal('admin'); closeEntryModal();">
                üîê Admin Login (Any Email/Password)
            </button>
        </div>
    </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal" class="login-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeLoginModal()">&times;</span>
        <h3 id="modalTitle">User Login</h3>
        <div id="userLoginForm">
            <input type="tel" id="phoneNumber" placeholder="Enter any phone number (e.g., 9876543210)" style="margin-bottom: 15px;">
            <div id="recaptcha-container"></div>
            <button class="btn btn-primary" onclick="sendOTP()" style="width:100%">Send OTP</button>
            <p style="text-align: center; margin-top: 15px; font-size: 0.9rem;">
                <a href="#" onclick="switchToAdminLogin()" style="color: var(--brand);">Admin Login ‚Üí</a>
            </p>
        </div>
        <div id="adminLoginForm" style="display: none;">
            <input type="email" id="adminEmail" placeholder="Enter any email" style="margin-bottom: 15px;">
            <input type="password" id="adminPassword" placeholder="Enter any password" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="adminLogin()" style="width:100%">Admin Login</button>
            <p style="text-align: center; margin-top: 15px; font-size: 0.9rem;">
                <a href="#" onclick="switchToUserLogin()" style="color: var(--brand);">User Login ‚Üí</a>
            </p>
        </div>
        <div id="otpContainer" style="display: none;">
            <input type="text" id="verificationCode" placeholder="Enter 123456 (demo OTP)" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="verifyOTP()" style="width:100%">Verify & Login</button>
        </div>
    </div>
</div>

<nav>
    <div class="logo">üèôÔ∏è CivicSpend</div>
    <div class="nav-links">
        <a href="#dashboard">Dashboard</a>
        <a href="#how-it-works">How It Works</a>
        <a href="#vote">Vote Priorities</a>
        <a href="#projects">Projects</a>
        <a href="#admin" id="adminLink" style="display: none;">Admin</a>
        <select id="languageSelect" onchange="changeLanguage()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: white;">
            <option value="en">English</option>
            <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
            <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
        </select>
        <span id="userStatus" class="user-status" style="display: none;"></span>
        <button class="btn btn-secondary" id="loginBtn" onclick="openLoginModal('user')">Login</button>
        <button class="btn" style="background: var(--danger); color: white;" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
    </div>
</nav>

<section class="hero">
    <h1 id="heroTitle">Government Spending, <br><span style="color:var(--brand)">Decoded for You.</span></h1>
    <p id="heroSubtitle">CivicSpend Pro bridges the gap between complex municipal ledgers and citizen understanding. Explore live data, track every rupee, and influence the city's future through decentralized feedback.</p>
    <div class="cta-group">
        <a href="#dashboard" class="btn btn-primary">Enter Dashboard</a>
        <a href="#how-it-works" class="btn" style="background: white; border: 1px solid #e2e8f0;">Learn More</a>
    </div>
</section>

<div class="dashboard-container" id="dashboard">
    <!-- MAIN CONTENT -->
    <main>
        <!-- BUDGET CHART -->
        <div class="card">
            <div class="data-freshness" id="dataFreshness">Data synced 2h ago</div>
            <span class="badge badge-blue">Live Expenditure Stream</span>
            <h2 id="chartTitle">Current Resource Allocation</h2>
            <p id="chartDesc" style="color: var(--slate-600); margin-bottom: 40px; line-height: 1.6;">
                This chart represents the <strong>validated treasury data</strong> for the fiscal year 2024-25. Data is pulled directly from the municipal accounting API and updated in real-time as warrants are issued.
            </p>
            <div id="main_chart" style="height: 550px; width: 100%;"></div>
            <div class="download-btns">
                <button onclick="downloadCSV()">üì• Download CSV</button>
                <button onclick="downloadJSON()">üì• Download JSON</button>
            </div>

            <!-- SEARCHABLE LEDGER -->
            <div class="search-container">
                <input type="text" class="search-input" id="ledgerSearch" placeholder="Search transactions (Roads, Contractor, Ward 5...)">
                <span class="search-icon">üîç</span>
            </div>
            <table class="ledger-table" id="ledgerTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Amount (‚Çπ)</th>
                        <th>Ward</th>
                        <th>Vendor</th>
                    </tr>
                </thead>
                <tbody id="ledgerBody">
                    <tr><td>2026-01-14</td><td>Education</td><td>Smart School Project</td><td>‚Çπ2,50,00,000</td><td>Ward 5</td><td>ABC Constructions</td></tr>
                    <tr><td>2026-01-13</td><td>Healthcare</td><td>Primary Health Center</td><td>‚Çπ1,80,00,000</td><td>Ward 7</td><td>MediCare Builders</td></tr>
                    <tr><td>2026-01-12</td><td>Infrastructure</td><td>Road Widening</td><td>‚Çπ3,20,00,000</td><td>Ward 3</td><td>Roads India Ltd</td></tr>
                    <tr><td>2026-01-11</td><td>Sanitation</td><td>Sewage Treatment Plant</td><td>‚Çπ4,50,00,000</td><td>Ward 9</td><td>CleanWater Tech</td></tr>
                </tbody>
            </table>
        </div>

        <!-- PUBLIC VOTE STATS -->
        <div class="card" style="margin-top:40px;">
            <span class="badge badge-orange">Public Sentiment</span>
            <h3 id="publicStatsTitle">Live Voting Stats</h3>
            <p id="publicStatsDesc" style="color: var(--slate-600); margin-top:0;">Aggregated stats only (no personal details).</p>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="publicTotalVotes">0</div>
                    <div id="publicTotalVotesLabel">Total votes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="publicTodayVotes">0</div>
                    <div id="publicTodayVotesLabel">Votes today</div>
                </div>
            </div>
            <div class="vote-demographics">
                <div>
                    <h5 id="publicAgeTitle">Age groups</h5>
                    <div id="publicAgeChart" class="demographic-chart"></div>
                </div>
                <div>
                    <h5 id="publicGenderTitle">Gender</h5>
                    <div id="publicGenderChart" class="demographic-chart"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- SIDEBAR -->
    <aside id="vote">
        <div class="card" id="vote_card">
            <span class="badge badge-green">Citizen Input Portal</span>
            <h3 id="voteTitle">Voice Your Priorities</h3>
            
            <div id="login_prompt" style="text-align: center;">
                <p id="loginPromptText" style="font-size: 0.9rem; color: var(--slate-600);">Verify your identity via SMS to vote.</p>
                <button class="btn btn-primary" onclick="openLoginModal('user')" style="width:100%; margin-top: 20px;">Login to Vote</button>
            </div>

            <div id="voting_controls" style="display: none;">
                <p id="user_welcome" style="font-size: 0.85rem; font-weight: 700; color: var(--brand); margin-bottom: 15px;"></p>
                
                <div style="background: var(--brand-soft); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px;">Your Profile</h4>
                    <select id="genderSelect">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="ageGroupSelect">
                        <option value="">Select Age Group</option>
                        <option value="18-25">18-25</option>
                        <option value="26-35">26-35</option>
                        <option value="36-50">36-50</option>
                        <option value="50+">50+</option>
                    </select>
                </div>

                <div class="input-group"><label id="eduLabel">Education <span id="val1">25%</span></label><input type="range" id="edu_p" value="25" min="0" max="100" oninput="updateSlider('val1', this.value)"></div>
                <div class="input-group"><label id="infLabel">Infrastructure <span id="val2">25%</span></label><input type="range" id="inf_p" value="25" min="0" max="100" oninput="updateSlider('val2', this.value)"></div>
                <div class="input-group"><label id="healthLabel">Healthcare <span id="val3">25%</span></label><input type="range" id="health_p" value="25" min="0" max="100" oninput="updateSlider('val3', this.value)"></div>
                <div class="input-group"><label id="sanLabel">Sanitation <span id="val4">25%</span></label><input type="range" id="san_p" value="25" min="0" max="100" oninput="updateSlider('val4', this.value)"></div>

                <textarea id="voteReason" placeholder="Why do you prioritize these areas? (Optional)" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px; resize:vertical; min-height:80px;"></textarea>
                
                <button class="btn btn-primary" style="width:100%;" onclick="sendFeedback()">Submit Priority Vote</button>
            </div>

            <div id="already_voted" style="display: none; text-align: center; padding: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;">‚úÖ</div>
                <h4 id="votedTitle">Identity Verified</h4>
                <p id="votedSubtitle" style="font-size: 0.85rem; color: var(--slate-600);">Your vote is securely recorded against your phone number.</p>
                <button class="btn" style="width:100%; margin-top:10px; font-size: 0.75rem;" onclick="logout()">Sign Out</button>
            </div>

            <!-- ADMIN DASHBOARD -->
            <div id="adminDashboard">
                <div class="admin-section">
                    <h4>üõ°Ô∏è Admin Dashboard</h4>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-number" id="totalVotes">0</div><div>Total Votes</div></div>
                        <div class="stat-card"><div class="stat-number" id="todayVotes">0</div><div>Today's Votes</div></div>
                        <div class="stat-card"><div class="stat-number" id="maleVotes">0</div><div>Male Voters</div></div>
                        <div class="stat-card"><div class="stat-number" id="femaleVotes">0</div><div>Female Voters</div></div>
                    </div>
                    <div class="vote-demographics">
                        <div><h5>Age Group Distribution</h5><div id="ageChart" class="demographic-chart"></div></div>
                        <div><h5>Gender Distribution</h5><div id="genderChart" class="demographic-chart"></div></div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h5>Recent Votes</h5>
                        <div id="recentVotesList" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </aside>
</div>

<!-- PROJECTS MAP -->
<section class="news-section" id="projects">
    <div class="section-title">
        <span class="badge badge-blue">Real World Impact</span>
        <h2 id="projectsTitle">Infrastructure Projects Map</h2>
        <p id="projectsSubtitle" style="color:var(--slate-600); max-width:600px; margin: 15px auto;">Click on markers to see project details and report issues.</p>
    </div>
    <div class="card" style="max-width: 1200px; margin: 0 auto 40px;">
        <div id="project-map"></div>
    </div>
</section>

<!-- HOW IT WORKS -->
<section class="how-it-works" id="how-it-works">
    <div class="section-title">
        <span class="badge badge-blue">Process Transparency</span>
        <h2 id="howTitle">How CivicSpend Works</h2>
    </div>
    <div class="grid-3">
        <div class="step-card">
            <div class="step-num">01</div>
            <h4 id="step1Title">Data Ingestion</h4>
            <p id="step1Desc">Our backend connects directly to the Municipal Financial Management System (MFMS), pulling raw expenditure data every 24 hours.</p>
        </div>
        <div class="step-card">
            <div class="step-num">02</div>
            <h4 id="step2Title">Visualization</h4>
            <p id="step2Desc">Complex spreadsheets are converted into intuitive charts using Google Charts API, making it easy for citizens to spot trends and anomalies.</p>
        </div>
        <div class="step-card">
            <div class="step-num">03</div>
            <h4 id="step3Title">Public Feedback</h4>
            <p id="step3Desc">Citizens use the priority sliders to "vote" on where they want future funds to go. This data is stored on Google Firebase for public audit.</p>
        </div>
    </div>
</section>

<!-- FAQ -->
<section class="faq-section">
    <div class="section-title">
        <span class="badge badge-blue">Resources</span>
        <h2 id="faqTitle">Common Questions</h2>
    </div>
    <div class="accordion">
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">Where does this data come from? <span>+</span></div>
            <div class="accordion-content">Our data is fetched from the Open Data portal of the Municipal Corporation. It is updated once the quarterly audits are finalized.</div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">How secure is my vote? <span>+</span></div>
            <div class="accordion-content">Votes are cryptographically signed and stored against your verified phone number. No personal data is shown publicly.</div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">Can I change my vote? <span>+</span></div>
            <div class="accordion-content">One vote per verified number per budget cycle. Contact support@civicspend.gov for special circumstances.</div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">Is this official government site? <span>+</span></div>
            <div class="accordion-content">CivicSpend Pro is a civic-tech initiative approved by the City Finance Department for transparency.</div>
        </div>
    </div>
</section>

<!-- AI CHATBOT -->
<div id="chatbot">
    <button class="btn btn-primary" onclick="toggleChatbot()" style="border-radius:999px; padding:12px 18px; box-shadow:0 4px 12px rgba(37,99,235,0.3);">
        üí¨ Help
    </button>
    <div id="chatbotPanel">
        <div style="padding:14px 16px; background:var(--brand); color:white; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:800;">CivicSpend Assistant</div>
            <button onclick="toggleChatbot()" style="background:transparent; border:none; color:white; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="chatMessages" style="padding:14px; height:300px; overflow:auto; background:#f8fafc;">
            <div><strong>Bot:</strong> Hello! I'm your CivicSpend assistant. Ask me about budget, voting, projects, or how the platform works.</div>
        </div>
        <div style="padding:12px; display:flex; gap:8px; border-top:1px solid #e2e8f0;">
            <input id="chatInput" type="text" placeholder="Ask about budget, voting, projects..." style="flex:1; padding:10px; border-radius:10px; border:1px solid #e2e8f0;">
            <button class="btn btn-primary" style="padding:10px 14px; border-radius:10px;" onclick="sendChat()">Send</button>
        </div>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-grid">
        <div>
            <h3 class="logo" style="color:white; margin-bottom: 1.5rem;">CivicSpend</h3>
            <p style="font-size: 0.9rem; color: #94a3b8; line-height: 1.6;">Making municipal finance accessible, understandable, and actionable for every citizen.</p>
        </div>
        <div>
            <h4>Project Links</h4>
            <ul>
                <li><a href="#">Audit Documentation</a></li>
                <li><a href="#">City Data API</a></li>
                <li><a href="#">Privacy Policy</a></li>
            </ul>
        </div>
        <div>
            <h4>Contact Us</h4>
            <ul>
                <li>üìß support@civicspend.gov</li>
                <li>üìç Finance Dept, City Hall</li>
                <li>üìû +91 44 2345 6789</li>
            </ul>
        </div>
    </div>
    <div class="footer-bottom">
        ¬© 2026 CivicSpend Pro. All rights reserved. Built with Firebase & Google Charts.
    </div>
</footer>

<script>
    // FIXED: SIMPLE JAVASCRIPT FUNCTIONS (No Firebase dependency for demo)
    
    // Global variables
    let currentUser = null;
    let isAdmin = false;
    let currentLanguage = 'en';
    let userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
    let adminStats = JSON.parse(localStorage.getItem('adminStats')) || { totalVotes: 0, todayVotes: 0, maleVotes: 0, femaleVotes: 0 };
    
    // ENTRY MODAL FUNCTIONS
    window.chooseEntry = function(type) {
        document.getElementById('entryUserActions').style.display = 'none';
        document.getElementById('entryAdminActions').style.display = 'none';
        
        if (type === 'user') {
            document.getElementById('entryUserActions').style.display = 'block';
        } else if (type === 'admin') {
            document.getElementById('entryAdminActions').style.display = 'block';
        }
    };
    
    window.closeEntryModal = function() {
        document.getElementById('entryModal').style.display = 'none';
    };
    
    window.enterAsGuest = function() {
        currentUser = null;
        isAdmin = false;
        closeEntryModal();
        updateUI();
    };
    
    // LOGIN MODAL FUNCTIONS
    window.openLoginModal = function(type) {
        document.getElementById('loginModal').style.display = 'block';
        
        if (type === 'user') {
            document.getElementById('userLoginForm').style.display = 'block';
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('otpContainer').style.display = 'none';
            document.getElementById('modalTitle').textContent = 'User Login';
        } else if (type === 'admin') {
            document.getElementById('userLoginForm').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('otpContainer').style.display = 'none';
            document.getElementById('modalTitle').textContent = 'Admin Login';
        }
    };
    
    window.closeLoginModal = function() {
        document.getElementById('loginModal').style.display = 'none';
    };
    
    window.switchToAdminLogin = function() {
        document.getElementById('userLoginForm').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'block';
        document.getElementById('otpContainer').style.display = 'none';
        document.getElementById('modalTitle').textContent = 'Admin Login';
    };
    
    window.switchToUserLogin = function() {
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('userLoginForm').style.display = 'block';
        document.getElementById('otpContainer').style.display = 'none';
        document.getElementById('modalTitle').textContent = 'User Login';
    };
    
    // ADMIN LOGIN - Accepts any email/password
    window.adminLogin = function() {
        const email = document.getElementById('adminEmail').value || 'admin@civicspend.gov';
        const password = document.getElementById('adminPassword').value || 'admin123';
        
        currentUser = {
            uid: 'admin-' + Date.now(),
            email: email,
            displayName: 'Admin User'
        };
        isAdmin = true;
        
        // Store in localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('isAdmin', 'true');
        
        closeLoginModal();
        updateUI();
        loadAdminStats();
        alert('‚úÖ Admin login successful!');
    };
    
    // USER OTP FUNCTIONS
    window.sendOTP = function() {
        const phoneNumber = document.getElementById('phoneNumber').value;
        
        if (!phoneNumber) {
            alert('Please enter a phone number');
            return;
        }
        
        // Simulate OTP sending
        document.getElementById('userLoginForm').style.display = 'none';
        document.getElementById('otpContainer').style.display = 'block';
        alert('Demo: OTP sent to ' + phoneNumber + '\nUse 123456 as OTP');
    };
    
    window.verifyOTP = function() {
        const otp = document.getElementById('verificationCode').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        
        if (otp === '123456') {
            currentUser = {
                uid: 'user-' + Date.now(),
                phoneNumber: phoneNumber || '+919876543210',
                displayName: 'Demo User'
            };
            isAdmin = false;
            
            // Store in localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('isAdmin', 'false');
            
            closeLoginModal();
            updateUI();
            alert('‚úÖ Login successful!');
        } else {
            alert('‚ùå Invalid OTP. Use 123456 for demo.');
        }
    };
    
    // LOGOUT
    window.logout = function() {
        currentUser = null;
        isAdmin = false;
        
        // Clear localStorage
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isAdmin');
        
        // Show entry modal again
        document.getElementById('entryModal').style.display = 'block';
        
        updateUI();
    };
    
    // UPDATE UI
    function updateUI() {
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userStatus = document.getElementById('userStatus');
        const adminLink = document.getElementById('adminLink');
        
        // Check localStorage for saved login
        const savedUser = localStorage.getItem('currentUser');
        const savedAdmin = localStorage.getItem('isAdmin');
        
        if (savedUser && !currentUser) {
            currentUser = JSON.parse(savedUser);
            isAdmin = savedAdmin === 'true';
        }
        
        if (currentUser) {
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            userStatus.style.display = 'inline';
            
            if (isAdmin) {
                userStatus.innerHTML = `<span class="admin-badge">ADMIN</span> ${currentUser.email || 'Admin'}`;
                adminLink.style.display = 'inline';
                document.getElementById('adminDashboard').style.display = 'block';
                
                // Hide voting interface for admin
                document.getElementById('login_prompt').style.display = 'none';
                document.getElementById('voting_controls').style.display = 'none';
                document.getElementById('already_voted').style.display = 'none';
            } else {
                userStatus.innerHTML = `üë§ ${currentUser.phoneNumber || 'User'}`;
                adminLink.style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'none';
                
                // Check if user has voted
                checkUserVote();
            }
        } else {
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            userStatus.style.display = 'none';
            adminLink.style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            
            // Show login prompt in vote card
            document.getElementById('login_prompt').style.display = 'block';
            document.getElementById('voting_controls').style.display = 'none';
            document.getElementById('already_voted').style.display = 'none';
        }
    }
    
    // CHECK USER VOTE
    function checkUserVote() {
        if (!currentUser || isAdmin) return;
        
        const hasVoted = userVotes[currentUser.uid];
        
        if (hasVoted) {
            document.getElementById('already_voted').style.display = 'block';
            document.getElementById('voting_controls').style.display = 'none';
            document.getElementById('login_prompt').style.display = 'none';
        } else {
            document.getElementById('user_welcome').innerText = "Verified: " + (currentUser.phoneNumber || 'User');
            document.getElementById('login_prompt').style.display = 'none';
            document.getElementById('voting_controls').style.display = 'block';
            document.getElementById('already_voted').style.display = 'none';
        }
    }
    
    // SEND FEEDBACK (VOTE)
    window.sendFeedback = function() {
        if (!currentUser || isAdmin) {
            alert('Please login as a user to vote');
            return;
        }
        
        const gender = document.getElementById('genderSelect').value;
        const ageGroup = document.getElementById('ageGroupSelect').value;
        
        if (!gender || !ageGroup) {
            alert('Please select gender and age group');
            return;
        }
        
        const voteData = {
            uid: currentUser.uid,
            phone: currentUser.phoneNumber || 'Not provided',
            gender: gender,
            ageGroup: ageGroup,
            edu: document.getElementById('edu_p').value,
            infra: document.getElementById('inf_p').value,
            health: document.getElementById('health_p').value,
            san: document.getElementById('san_p').value,
            reason: document.getElementById('voteReason').value,
            timestamp: new Date().toISOString()
        };
        
        // Store vote
        userVotes[currentUser.uid] = voteData;
        localStorage.setItem('userVotes', JSON.stringify(userVotes));
        
        // Update admin stats
        adminStats.totalVotes = Object.keys(userVotes).length;
        adminStats.todayVotes = (adminStats.todayVotes || 0) + 1;
        if (gender === 'male') adminStats.maleVotes = (adminStats.maleVotes || 0) + 1;
        if (gender === 'female') adminStats.femaleVotes = (adminStats.femaleVotes || 0) + 1;
        localStorage.setItem('adminStats', JSON.stringify(adminStats));
        
        alert('‚úÖ Vote submitted successfully!');
        checkUserVote();
        loadPublicStats();
        
        if (isAdmin) {
            loadAdminStats();
        }
    };
    
    // LOAD PUBLIC STATS
    function loadPublicStats() {
        const votes = Object.values(userVotes);
        const today = new Date().toDateString();
        const todayVotes = votes.filter(vote => new Date(vote.timestamp).toDateString() === today).length;
        
        document.getElementById('publicTotalVotes').textContent = votes.length;
        document.getElementById('publicTodayVotes').textContent = todayVotes;
        
        // Load charts
        loadCharts();
    }
    
    // LOAD ADMIN STATS
    function loadAdminStats() {
        if (!isAdmin) return;
        
        document.getElementById('totalVotes').textContent = adminStats.totalVotes || 0;
        document.getElementById('todayVotes').textContent = adminStats.todayVotes || 0;
        document.getElementById('maleVotes').textContent = adminStats.maleVotes || 0;
        document.getElementById('femaleVotes').textContent = adminStats.femaleVotes || 0;
        
        // Load recent votes
        const recentVotesList = document.getElementById('recentVotesList');
        recentVotesList.innerHTML = '';
        
        const votes = Object.values(userVotes).slice(-5).reverse();
        votes.forEach(vote => {
            const div = document.createElement('div');
            div.style.padding = '5px';
            div.style.borderBottom = '1px solid #e2e8f0';
            div.innerHTML = `<strong>${vote.phone}</strong>: Edu ${vote.edu}%, Infra ${vote.infra}%, Health ${vote.health}%`;
            recentVotesList.appendChild(div);
        });
    }
    
    // LOAD CHARTS
    function loadCharts() {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(function() {
            // Budget chart
            const budgetData = google.visualization.arrayToDataTable([
                ['Category', 'Amount (‚Çπ Cr)', {role: 'style'}],
                ['Education', 45, '#2563eb'],
                ['Healthcare', 32, '#10b981'],
                ['Infrastructure', 58, '#f59e0b'],
                ['Sanitation', 25, '#ef4444']
            ]);
            
            const budgetOptions = {
                pieHole: 0.6,
                chartArea: {width: '90%', height: '80%'},
                legend: {position: 'bottom'},
                backgroundColor: 'transparent'
            };
            
            const budgetChart = new google.visualization.PieChart(document.getElementById('main_chart'));
            budgetChart.draw(budgetData, budgetOptions);
            
            // Age chart
            const votes = Object.values(userVotes);
            const ageCounts = { '18-25': 0, '26-35': 0, '36-50': 0, '50+': 0 };
            const genderCounts = { 'male': 0, 'female': 0, 'other': 0 };
            
            votes.forEach(vote => {
                if (vote.ageGroup && ageCounts[vote.ageGroup] !== undefined) {
                    ageCounts[vote.ageGroup]++;
                }
                if (vote.gender && genderCounts[vote.gender] !== undefined) {
                    genderCounts[vote.gender]++;
                }
            });
            
            const ageData = google.visualization.arrayToDataTable([
                ['Age', 'Votes', {role: 'style'}],
                ['18-25', ageCounts['18-25'], '#2563eb'],
                ['26-35', ageCounts['26-35'], '#10b981'],
                ['36-50', ageCounts['36-50'], '#f59e0b'],
                ['50+', ageCounts['50+'], '#ef4444']
            ]);
            
            const genderData = google.visualization.arrayToDataTable([
                ['Gender', 'Votes', {role: 'style'}],
                ['Male', genderCounts['male'], '#2563eb'],
                ['Female', genderCounts['female'], '#10b981'],
                ['Other', genderCounts['other'], '#f59e0b']
            ]);
            
            const ageChart = new google.visualization.ColumnChart(document.getElementById('publicAgeChart'));
            ageChart.draw(ageData, {legend: 'none', backgroundColor: 'transparent'});
            
            const genderChart = new google.visualization.ColumnChart(document.getElementById('publicGenderChart'));
            genderChart.draw(genderData, {legend: 'none', backgroundColor: 'transparent'});
            
            // Admin charts
            if (isAdmin) {
                const adminAgeChart = new google.visualization.ColumnChart(document.getElementById('ageChart'));
                adminAgeChart.draw(ageData, {legend: 'none', backgroundColor: 'transparent'});
                
                const adminGenderChart = new google.visualization.ColumnChart(document.getElementById('genderChart'));
                adminGenderChart.draw(genderData, {legend: 'none', backgroundColor: 'transparent'});
            }
        });
    }
    
    // MAP INITIALIZATION
    function initMap() {
        if (typeof L !== 'undefined') {
            const map = L.map('project-map').setView([12.9716, 77.5946], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add markers
            const markers = [
                { lat: 12.9716, lng: 77.5946, title: 'Smart City Project', desc: 'Digital infrastructure upgrade' },
                { lat: 12.9816, lng: 77.5846, title: 'Metro Expansion', desc: 'New metro line construction' },
                { lat: 12.9616, lng: 77.6046, title: 'Waste Management', desc: 'New recycling plant' },
                { lat: 12.9766, lng: 77.5996, title: 'Public Park', desc: 'Green space development' }
            ];
            
            markers.forEach(marker => {
                L.marker([marker.lat, marker.lng])
                    .addTo(map)
                    .bindPopup(`<b>${marker.title}</b><br>${marker.desc}`);
            });
        }
    }
    
    // UTILITY FUNCTIONS
    window.updateSlider = function(id, value) {
        document.getElementById(id).textContent = value + '%';
    };
    
    window.toggleAccordion = function(header) {
        const content = header.nextElementSibling;
        content.classList.toggle('active');
        header.lastElementChild.textContent = content.classList.contains('active') ? '‚àí' : '+';
    };
    
    window.downloadCSV = function() {
        const csv = 'Date,Category,Description,Amount,Ward,Vendor\n' +
                   '2026-01-14,Education,Smart School Project,25000000,Ward 5,ABC Constructions\n' +
                   '2026-01-13,Healthcare,Primary Health Center,18000000,Ward 7,MediCare Builders\n' +
                   '2026-01-12,Infrastructure,Road Widening,32000000,Ward 3,Roads India Ltd\n' +
                   '2026-01-11,Sanitation,Sewage Treatment Plant,45000000,Ward 9,CleanWater Tech';
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'civicspend_ledger.csv';
        a.click();
    };
    
    window.downloadJSON = function() {
        const data = {
            ledger: [
                { date: '2026-01-14', category: 'Education', description: 'Smart School Project', amount: 25000000, ward: 'Ward 5', vendor: 'ABC Constructions' },
                { date: '2026-01-13', category: 'Healthcare', description: 'Primary Health Center', amount: 18000000, ward: 'Ward 7', vendor: 'MediCare Builders' },
                { date: '2026-01-12', category: 'Infrastructure', description: 'Road Widening', amount: 32000000, ward: 'Ward 3', vendor: 'Roads India Ltd' },
                { date: '2026-01-11', category: 'Sanitation', description: 'Sewage Treatment Plant', amount: 45000000, ward: 'Ward 9', vendor: 'CleanWater Tech' }
            ]
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'civicspend_data.json';
        a.click();
    };
    
    window.changeLanguage = function() {
        currentLanguage = document.getElementById('languageSelect').value;
        // Translation implementation would go here
        alert('Language changed to ' + (currentLanguage === 'en' ? 'English' : 
                                      currentLanguage === 'ta' ? 'Tamil' : 'Hindi'));
    };
    
    // CHATBOT FUNCTIONS
    window.toggleChatbot = function() {
        const panel = document.getElementById('chatbotPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    };
    
    window.sendChat = function() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        const chatMessages = document.getElementById('chatMessages');
        
        // Add user message
        chatMessages.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
        input.value = '';
        
        // Generate bot response
        const response = generateBotResponse(message);
        
        // Add bot response after a short delay
        setTimeout(() => {
            chatMessages.innerHTML += `<div><strong>Bot:</strong> ${response}</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 500);
    };
    
    function generateBotResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        // Improved chatbot responses
        if (lowerMessage.includes('budget') || lowerMessage.includes('spending') || lowerMessage.includes('money')) {
            return "The current annual budget is ‚Çπ160 Cr allocated across Education (28%), Healthcare (20%), Infrastructure (36%), and Sanitation (16%). You can see the detailed breakdown in the main chart above.";
        } else if (lowerMessage.includes('vote') || lowerMessage.includes('voting') || lowerMessage.includes('priority')) {
            return "You can vote on budget priorities by logging in with your phone number. Use the sliders to allocate percentages to Education, Infrastructure, Healthcare, and Sanitation. Each verified user gets one vote per budget cycle.";
        } else if (lowerMessage.includes('project') || lowerMessage.includes('map') || lowerMessage.includes('location')) {
            return "Check the Infrastructure Projects Map section to see active projects in your city. Click on markers for details and to report issues.";
        } else if (lowerMessage.includes('login') || lowerMessage.includes('sign in') || lowerMessage.includes('register')) {
            return "Users: Click 'Login to Vote' and enter any phone number. Use '123456' as OTP. Admins: Use any email and password to login as admin.";
        } else if (lowerMessage.includes('admin') || lowerMessage.includes('dashboard')) {
            return "Admin dashboard shows voting statistics, demographic breakdowns, and recent votes. Login as admin with any email/password to access.";
        } else if (lowerMessage.includes('data') || lowerMessage.includes('source') || lowerMessage.includes('where')) {
            return "Data comes from the Municipal Financial Management System (MFMS) and is updated every 24 hours. All data is validated and audited quarterly.";
        } else if (lowerMessage.includes('help') || lowerMessage.includes('how') || lowerMessage.includes('what')) {
            return "I can help with: 1) Budget information 2) Voting process 3) Project locations 4) Login help 5) Data sources. What would you like to know?";
        } else if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
            return "Hello! I'm your CivicSpend assistant. How can I help you today?";
        } else {
            return "I understand you're asking about '" + message.split(' ')[0] + "'. For specific help with budget, voting, projects, or login issues, please ask more specifically or check the FAQ section.";
        }
    }
    
    // INITIALIZE ON LOAD
    window.addEventListener('load', function() {
        // Initialize map
        initMap();
        
        // Load statistics
        loadPublicStats();
        
        // Update UI
        updateUI();
        
        // Update data freshness
        updateDataFreshness();
        setInterval(updateDataFreshness, 60000);
        
        // Initialize search
        document.getElementById('ledgerSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#ledgerBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    });
    
    function updateDataFreshness() {
        const hours = Math.floor(Math.random() * 6);
        document.getElementById('dataFreshness').textContent = `Data synced ${hours}h ago`;
    }
</script>

</body>
</html>
