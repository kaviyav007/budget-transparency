<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicSpend Pro | Public Transparency Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --brand: #2563eb;
            --brand-soft: #eff6ff;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --slate-900: #0f172a;
            --slate-600: #475569;
            --slate-100: #f1f5f9;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; background-color: #f8fafc; color: var(--slate-900);
            scroll-behavior: smooth;
        }

        /* Make ALL interactive elements clickable */
        a, button, select, input[type="checkbox"], .accordion-header {
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        /* MODALS */
        .login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .login-modal.show {
            display: block;
            opacity: 1;
        }
        .modal-content {
            background: white; margin: 10% auto; width: 90%; max-width: 500px; 
            border-radius: 20px; padding: 40px; position: relative;
            transform: translateY(-20px);
            transition: transform 0.4s ease;
        }
        .login-modal.show .modal-content {
            transform: translateY(0);
        }
        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 2rem; cursor: pointer; }

        /* ENTRY MODAL - FIRST LOAD */
        #entryModal { 
            display: block !important;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        #entryModal.show {
            opacity: 1;
        }

        /* NAVIGATION */
        nav {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 1rem 5%; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--slate-100);
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-weight: 800; font-size: 1.4rem; color: var(--brand); letter-spacing: -0.5px; }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-links a { 
            text-decoration: none; color: var(--slate-600); font-weight: 600; 
            font-size: 0.9rem; transition: 0.2s; cursor: pointer;
            padding: 8px 12px; border-radius: 6px;
        }
        .nav-links a:hover { color: var(--brand); background: var(--brand-soft); }
        .user-status { font-weight: 600; color: var(--brand); }
        .admin-badge { background: #fef3c7; color: var(--warning); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }

        /* HERO */
        .hero {
            padding: 120px 10% 160px; text-align: center;
            background: radial-gradient(circle at 50% 0%, #e0f2fe 0%, #f8fafc 100%);
        }
        .hero h1 { font-size: 4rem; font-weight: 800; margin-bottom: 1.5rem; line-height: 1.1; letter-spacing: -2px; }
        .hero p { font-size: 1.35rem; color: var(--slate-600); max-width: 800px; margin: 0 auto 3rem; line-height: 1.6; }
        .cta-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 16px 32px; border-radius: 14px; font-weight: 700; text-decoration: none; transition: 0.3s; cursor: pointer; border: none; font-size: 1rem; }
        .btn-primary { background: var(--brand); color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.3); }
        .btn-secondary { background: white; border: 2px solid var(--brand); color: var(--brand); }

        /* DASHBOARD */
        .dashboard-container {
            max-width: 1400px; margin: -100px auto 100px; padding: 0 20px;
            display: grid; grid-template-columns: 1.8fr 1fr; gap: 40px;
        }
        .card { 
            background: white; border-radius: 28px; padding: 40px; 
            border: 1px solid var(--slate-100); box-shadow: 0 10px 30px rgba(0,0,0,0.04); 
            position: relative;
        }
        .data-freshness { position: absolute; top: 20px; right: 20px; font-size: 0.75rem; color: var(--success); font-weight: 600; }

        /* STATS & CHARTS */
        .badge { display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; }
        .badge-blue { background: var(--brand-soft); color: var(--brand); }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-orange { background: #fef3c7; color: #92400e; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; text-align: center; border: 1px solid #f3e8ff; }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--brand); }
        .vote-demographics { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .demographic-chart { height: 300px; }

        /* SEARCH & TABLE */
        .search-container { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 14px 45px 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; }
        .search-icon { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--slate-600); }
        .download-btns { display: flex; gap: 10px; margin-top: 15px; }
        .download-btns button { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; cursor: pointer; font-weight: 600; }
        .ledger-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .ledger-table th, .ledger-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .ledger-table th { background: #f8fafc; font-weight: 700; color: var(--slate-900); }
        .ledger-table tr:hover { background: var(--brand-soft); }

        /* MAP */
        #project-map { height: 400px; border-radius: 16px; margin-top: 20px; }

        /* FORMS */
        .input-group { background: #f8fafc; padding: 22px; border-radius: 18px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .input-group label { display: flex; justify-content: space-between; font-weight: 700; font-size: 1rem; }
        input[type=range] { width: 100%; height: 8px; accent-color: var(--brand); margin: 18px 0 10px; cursor: pointer; }
        select, input[type="text"], input[type="email"], input[type="password"], textarea { 
            width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 8px 0; 
        }

        /* ADMIN */
        .admin-section { background: #fef7ff; border: 2px solid #e879f9; border-radius: 20px; padding: 30px; margin-bottom: 20px; }
        #adminDashboard { display: none; }

        /* CHATBOT */
        #chatbot { position: fixed; right: 18px; bottom: 18px; z-index: 3000; }
        #chatbotPanel { display: none; width: 320px; max-width: 85vw; height: 420px; background: white; border: 1px solid #e2e8f0; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-top: 10px; overflow: hidden; }

        /* SECTIONS */
        .how-it-works, .faq-section, .news-section { padding: 100px 10%; }
        .section-title { text-align: center; margin-bottom: 60px; }
        .section-title h2 { font-size: 2.5rem; font-weight: 800; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
        .step-card { padding: 30px; text-align: left; border-radius: 20px; background: #f8fafc; border: 1px solid #f1f5f9; }
        .step-num { width: 40px; height: 40px; background: var(--brand); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-bottom: 20px; }
        .accordion-item { background: white; margin-bottom: 15px; border-radius: 15px; border: 1px solid #e2e8f0; overflow: hidden; }
        .accordion-header { padding: 20px 25px; cursor: pointer; display: flex; justify-content: space-between; font-weight: 700; transition: 0.3s; }
        .accordion-header:hover { background: var(--brand-soft); }
        .accordion-content { padding: 0 25px 20px; color: var(--slate-600); font-size: 0.95rem; line-height: 1.6; max-height: 0; overflow: hidden; transition: 0.3s; }
        .accordion-content.active { max-height: 200px; padding: 25px 25px 20px; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .news-card { border-radius: 20px; overflow: hidden; border: 1px solid #f1f5f9; transition: 0.3s; position: relative; }
        .news-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .news-img { width: 100%; height: 180px; object-fit: cover; display: block; }
        .news-body { padding: 20px; }
        .report-issue { position: absolute; bottom: 10px; right: 10px; background: var(--danger); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

        /* RESPONSIVE */
        @media (max-width: 1000px) { 
            .dashboard-container { grid-template-columns: 1fr; } 
            .hero h1 { font-size: 2.8rem; }
            .vote-demographics { grid-template-columns: 1fr; }
            .nav-links { flex-wrap: wrap; gap: 10px; }
        }
        footer { background: var(--slate-900); color: white; padding: 80px 10%; margin-top: 0; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 50px; }
        .footer-bottom { border-top: 1px solid #334155; margin-top: 60px; padding-top: 30px; font-size: 0.85rem; color: #94a3b8; text-align: center; }
    </style>
</head>
    <script src="github-fix.js"></script>
<body>

<!-- ENTRY MODAL - FIRST LOAD BLOCKER -->
<div id="entryModal" class="login-modal">
    <div class="modal-content">
        <h3>Welcome to CivicSpend Pro</h3>
        <p style="color:var(--slate-600)">Choose how you want to access the platform:</p>
        <div style="display:flex; gap:12px; margin-top:18px; flex-wrap:wrap;">
            <button class="btn btn-primary" style="flex:1" onclick="chooseEntry('user')">üë§ Continue as User</button>
            <button class="btn btn-secondary" style="flex:1" onclick="chooseEntry('admin')">üõ°Ô∏è Continue as Admin</button>
        </div>
        <div id="entryUserActions" style="margin-top:18px; display:none;">
            <button class="btn" style="width:100%; border:1px solid #e2e8f0; background:white;" onclick="enterAsGuest()">
                üëÅÔ∏è Browse as Guest (no vote)
            </button>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openLoginModal(); closeEntryModal();">
                üì± Login to Vote (OTP)
            </button>
        </div>
        <div id="entryAdminActions" style="margin-top:18px; display:none;">
            <button class="btn btn-primary" style="width:100%;" onclick="openAdminLogin(); closeEntryModal();">
                üîê Admin Login (Any Email/Password)
            </button>
        </div>
    </div>
</div>

<!-- USER LOGIN MODAL -->
<div id="loginModal" class="login-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeLoginModal()">&times;</span>
        <h3>User Login</h3>
        <div id="userLoginForm">
            <input type="tel" id="phoneNumber" placeholder="Enter phone number (e.g., 9876543210)" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="sendOTP()" style="width:100%">Send OTP</button>
            <p style="text-align: center; margin-top: 15px; font-size: 0.9rem;">
                <span style="color: var(--slate-600);">Demo: OTP will be 123456</span>
            </p>
        </div>
        <div id="otpContainer" style="display: none;">
            <input type="text" id="verificationCode" placeholder="Enter OTP (123456 for demo)" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="verifyOTP()" style="width:100%">Verify & Login</button>
        </div>
    </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="adminLoginModal" class="login-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAdminLoginModal()">&times;</span>
        <h3>Admin Login</h3>
        <div id="adminLoginForm">
            <input type="email" id="adminEmail" placeholder="Enter any email" style="margin-bottom: 15px;">
            <input type="password" id="adminPassword" placeholder="Enter any password" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="adminLogin()" style="width:100%">Login as Admin</button>
            <p style="text-align: center; margin-top: 15px; font-size: 0.9rem;">
                <span style="color: var(--slate-600);">Accepts any email/password</span>
            </p>
        </div>
    </div>
</div>

<nav>
    <div class="logo">üèôÔ∏è CivicSpend</div>
    <div class="nav-links">
        <a href="#dashboard">Dashboard</a>
        <a href="#how-it-works">How It Works</a>
        <a href="#vote">Vote Priorities</a>
        <a href="#projects">Projects</a>
        <a href="#admin" id="adminLink" style="display: none;">Admin</a>
        <select id="languageSelect">
            <option value="en">English</option>
            <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
            <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
        </select>
        <span id="userStatus" class="user-status" style="display: none;"></span>
        <button class="btn btn-secondary" id="loginBtn" onclick="openLoginModal()">Login</button>
        <button class="btn" style="background: var(--danger); color: white;" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
    </div>
</nav>

<!-- DASHBOARD SECTION -->
<section id="dashboard">
    <div class="hero">
        <h1 id="heroTitle">Government Spending, <br><span style="color:var(--brand)">Decoded for You.</span></h1>
        <p id="heroSubtitle">CivicSpend Pro bridges the gap between complex municipal ledgers and citizen understanding. Explore live data, track every rupee, and influence the city's future through decentralized feedback.</p>
        <div class="cta-group">
            <a href="#dashboard" class="btn btn-primary">Enter Dashboard</a>
            <a href="#how-it-works" class="btn" style="background: white; border: 1px solid #e2e8f0;">Learn More</a>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- MAIN CONTENT -->
        <main>
            <!-- BUDGET CHART -->
            <div class="card">
                <div class="data-freshness" id="dataFreshness">Data synced 2h ago</div>
                <span class="badge badge-blue">Live Expenditure Stream</span>
                <h2 id="chartTitle">Current Resource Allocation</h2>
                <p id="chartDesc" style="color: var(--slate-600); margin-bottom: 40px; line-height: 1.6;">
                    This chart represents the <strong>validated treasury data</strong> for the fiscal year 2024-25. Data is pulled directly from the municipal accounting API and updated in real-time as warrants are issued.
                </p>
                <div id="main_chart" style="height: 550px; width: 100%;"></div>
                
                <!-- YEAR-OVER-YEAR COMPARISON -->
                <div style="margin-top: 40px;">
                    <h4 id="yearCompareTitle">Year-over-Year Comparison</h4>
                    <div id="year_comparison_chart" style="height: 300px; width: 100%; margin-top: 20px;"></div>
                </div>
                
                <!-- BUDGET VS ACTUAL -->
                <div style="margin-top: 40px;">
                    <h4 id="budgetActualTitle">Budget vs Actual Spending</h4>
                    <div id="budget_actual_chart" style="height: 300px; width: 100%; margin-top: 20px;"></div>
                </div>

                <div class="download-btns">
                    <button onclick="downloadCSV()">üì• Download CSV</button>
                    <button onclick="downloadJSON()">üì• Download JSON</button>
                    <button onclick="downloadPDF()">üì• Download PDF Report</button>
                </div>

                <!-- SEARCHABLE LEDGER -->
                <div class="search-container">
                    <input type="text" class="search-input" id="ledgerSearch" placeholder="Search transactions (Roads, Contractor, Ward 5...)">
                    <span class="search-icon">üîç</span>
                </div>
                <table class="ledger-table" id="ledgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Ward</th>
                            <th>Vendor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody"></tbody>
                </table>
            </div>

            <!-- PUBLIC VOTE STATS -->
            <div class="card" style="margin-top:40px;">
                <span class="badge badge-orange">Public Sentiment</span>
                <h3 id="publicStatsTitle">Live Voting Stats</h3>
                <p id="publicStatsDesc" style="color: var(--slate-600); margin-top:0;">Aggregated stats only (no personal details).</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="publicTotalVotes">0</div>
                        <div id="publicTotalVotesLabel">Total votes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="publicTodayVotes">0</div>
                        <div id="publicTodayVotesLabel">Votes today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="publicAvgEducation">25%</div>
                        <div id="publicAvgEducationLabel">Avg Education</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="publicAvgInfra">25%</div>
                        <div id="publicAvgInfraLabel">Avg Infrastructure</div>
                    </div>
                </div>
                <div class="vote-demographics">
                    <div>
                        <h5 id="publicAgeTitle">Age groups</h5>
                        <div id="publicAgeChart" class="demographic-chart"></div>
                    </div>
                    <div>
                        <h5 id="publicGenderTitle">Gender</h5>
                        <div id="publicGenderChart" class="demographic-chart"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- SIDEBAR -->
        <aside>
            <div class="card" id="vote">
                <span class="badge badge-green">Citizen Input Portal</span>
                <h3 id="voteTitle">Voice Your Priorities</h3>
                
                <div id="login_prompt" style="text-align: center;">
                    <p id="loginPromptText" style="font-size: 0.9rem; color: var(--slate-600);">Verify your identity via SMS to vote.</p>
                    <button class="btn btn-primary" onclick="openLoginModal()" style="width:100%; margin-top: 20px;">Login to Vote</button>
                </div>

                <div id="voting_controls" style="display: none;">
                    <p id="user_welcome" style="font-size: 0.85rem; font-weight: 700; color: var(--brand); margin-bottom: 15px;"></p>
                    
                    <div style="background: var(--brand-soft); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px;">Your Profile</h4>
                        <select id="genderSelect">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                        <select id="ageGroupSelect">
                            <option value="">Select Age Group</option>
                            <option value="18-25">18-25</option>
                            <option value="26-35">26-35</option>
                            <option value="36-50">36-50</option>
                            <option value="50+">50+</option>
                        </select>
                        <select id="wardSelect">
                            <option value="">Select Your Ward</option>
                            <option value="Ward 1">Ward 1</option>
                            <option value="Ward 2">Ward 2</option>
                            <option value="Ward 3">Ward 3</option>
                            <option value="Ward 4">Ward 4</option>
                            <option value="Ward 5">Ward 5</option>
                        </select>
                    </div>

                    <div class="input-group"><label id="eduLabel">Education <span id="val1">25%</span></label><input type="range" id="edu_p" value="25" min="0" max="100" oninput="updateSliderValue('val1', this.value)"></div>
                    <div class="input-group"><label id="infLabel">Infrastructure <span id="val2">25%</span></label><input type="range" id="inf_p" value="25" min="0" max="100" oninput="updateSliderValue('val2', this.value)"></div>
                    <div class="input-group"><label id="healthLabel">Healthcare <span id="val3">25%</span></label><input type="range" id="health_p" value="25" min="0" max="100" oninput="updateSliderValue('val3', this.value)"></div>
                    <div class="input-group"><label id="sanLabel">Sanitation <span id="val4">25%</span></label><input type="range" id="san_p" value="25" min="0" max="100" oninput="updateSliderValue('val4', this.value)"></div>

                    <textarea id="voteReason" placeholder="Why do you prioritize these areas? (Optional but recommended)" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px; resize:vertical; min-height:80px;"></textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="checkbox" id="followUpdates" checked>
                        <label for="followUpdates" style="font-size: 0.85rem; color: var(--slate-600);">Send me updates on budget decisions</label>
                    </div>
                    
                    <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="sendFeedback()">Submit Priority Vote</button>
                    
                    <div id="totalDisplay" style="margin-top: 15px; padding: 10px; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; text-align: center;">
                        Total: <span id="totalPercent">100%</span>
                    </div>
                </div>

                <div id="already_voted" style="display: none; text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">‚úÖ</div>
                    <h4 id="votedTitle">Identity Verified</h4>
                    <p id="votedSubtitle" style="font-size: 0.85rem; color: var(--slate-600);">Your vote is securely recorded against your phone number.</p>
                    <button class="btn" style="width:100%; margin-top:10px; font-size: 0.75rem;" onclick="logout()">Sign Out</button>
                </div>

                <!-- ADMIN DASHBOARD -->
                <div id="adminDashboard">
                    <div class="admin-section">
                        <h4>üõ°Ô∏è Admin Dashboard</h4>
                        <div class="stats-grid">
                            <div class="stat-card"><div class="stat-number" id="totalVotes">0</div><div>Total Votes</div></div>
                            <div class="stat-card"><div class="stat-number" id="todayVotes">0</div><div>Today's Votes</div></div>
                            <div class="stat-card"><div class="stat-number" id="maleVotes">0</div><div>Male Voters</div></div>
                            <div class="stat-card"><div class="stat-number" id="femaleVotes">0</div><div>Female Voters</div></div>
                            <div class="stat-card"><div class="stat-number" id="ward1Votes">0</div><div>Ward 1 Votes</div></div>
                            <div class="stat-card"><div class="stat-number" id="ward2Votes">0</div><div>Ward 2 Votes</div></div>
                        </div>
                        <div class="vote-demographics">
                            <div><h5>Age Group Distribution</h5><div id="ageChart" class="demographic-chart"></div></div>
                            <div><h5>Gender Distribution</h5><div id="genderChart" class="demographic-chart"></div></div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h5>Recent Votes</h5>
                            <div id="recentVotesList" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem; background: #f8fafc; padding: 10px; border-radius: 8px;"></div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h5>Average Priorities</h5>
                            <div id="avgPriorities" style="background: #f8fafc; padding: 10px; border-radius: 8px; font-size: 0.85rem;">
                                <div>Education: <span id="avgEdu">25%</span></div>
                                <div>Infrastructure: <span id="avgInfra">25%</span></div>
                                <div>Healthcare: <span id="avgHealth">25%</span></div>
                                <div>Sanitation: <span id="avgSan">25%</span></div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" style="width:100%;" onclick="exportVoteData()">üìä Export Vote Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</section>

<!-- PROJECTS SECTION -->
<section id="projects" class="news-section">
    <div class="section-title">
        <span class="badge badge-blue">Real World Impact</span>
        <h2 id="projectsTitle">Infrastructure Projects Map</h2>
        <p id="projectsSubtitle" style="color:var(--slate-600); max-width:600px; margin: 15px auto;">Click on markers to see project details and report issues.</p>
    </div>
    <div class="card" style="max-width: 1200px; margin: 0 auto 40px;">
        <div id="project-map"></div>
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <div>
                <h5>Filter by Ward:</h5>
                <select id="wardFilter" onchange="filterMapByWard()">
                    <option value="all">All Wards</option>
                    <option value="1">Ward 1</option>
                    <option value="2">Ward 2</option>
                    <option value="3">Ward 3</option>
                    <option value="4">Ward 4</option>
                    <option value="5">Ward 5</option>
                </select>
            </div>
            <div>
                <h5>Filter by Status:</h5>
                <select id="statusFilter" onchange="filterMapByStatus()">
                    <option value="all">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="progress">In Progress</option>
                    <option value="planned">Planned</option>
                </select>
            </div>
        </div>
    </div>
</section>

<!-- HOW IT WORKS SECTION -->
<section id="how-it-works" class="how-it-works">
    <div class="section-title">
        <span class="badge badge-blue">Process Transparency</span>
        <h2 id="howTitle">How CivicSpend Works</h2>
    </div>
    <div class="grid-3">
        <div class="step-card">
            <div class="step-num">01</div>
            <h4 id="step1Title">Data Ingestion</h4>
            <p id="step1Desc">Our backend connects directly to the Municipal Financial Management System (MFMS), pulling raw expenditure data every 24 hours.</p>
        </div>
        <div class="step-card">
            <div class="step-num">02</div>
            <h4 id="step2Title">Visualization</h4>
            <p id="step2Desc">Complex spreadsheets are converted into intuitive charts using Google Charts API, making it easy for citizens to spot trends and anomalies.</p>
        </div>
        <div class="step-card">
            <div class="step-num">03</div>
            <h4 id="step3Title">Public Feedback</h4>
            <p id="step3Desc">Citizens use the priority sliders to "vote" on where they want future funds to go. This data is stored on Google Firebase for public audit.</p>
        </div>
    </div>
</section>

<!-- FAQ SECTION -->
<section class="faq-section">
    <div class="section-title">
        <span class="badge badge-blue">Resources</span>
        <h2 id="faqTitle">Common Questions</h2>
    </div>
    <div class="accordion">
        <div class="accordion-item">
            <div class="accordion-header"><span id="faq1">Where does this data come from?</span> <span>+</span></div>
            <div class="accordion-content"><span id="faq1a">Our data is fetched from the Open Data portal of the Municipal Corporation. It is updated once the quarterly audits are finalized.</span></div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header"><span id="faq2">How secure is my vote?</span> <span>+</span></div>
            <div class="accordion-content"><span id="faq2a">Votes are cryptographically signed and stored against your verified phone number. No personal data is shown publicly.</span></div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header"><span id="faq3">Can I change my vote?</span> <span>+</span></div>
            <div class="accordion-content"><span id="faq3a">One vote per verified number per budget cycle. Contact support@civicspend.gov for special circumstances.</span></div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header"><span id="faq4">Is this official government site?</span> <span>+</span></div>
            <div class="accordion-content"><span id="faq4a">CivicSpend Pro is a civic-tech initiative approved by the City Finance Department for transparency.</span></div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header"><span id="faq5">How often is data updated?</span> <span>+</span></div>
            <div class="accordion-content"><span id="faq5a">Financial data is updated every 24 hours. Project status updates are real-time as reported by field officers.</span></div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header"><span id="faq6">Who can see my vote?</span> <span>+</span></div>
            <div class="accordion-content"><span id="faq6a">Only aggregated anonymous statistics are shown publicly. Individual votes are visible only to authorized administrators for analysis.</span></div>
        </div>
    </div>
</section>

<!-- AI CHATBOT -->
<div id="chatbot">
    <button class="btn btn-primary" onclick="toggleChatbot()" style="border-radius:999px; padding:12px 18px; box-shadow:0 4px 12px rgba(37,99,235,0.3);">
        üí¨ Civic Assistant
    </button>
    <div id="chatbotPanel">
        <div style="padding:14px 16px; background:var(--brand); color:white; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:800;">CivicSpend Assistant</div>
            <button onclick="toggleChatbot()" style="background:transparent; border:none; color:white; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="chatMessages" style="padding:14px; height:300px; overflow:auto; background:#f8fafc;">
            <div><strong>Bot:</strong> Hello! I'm your CivicSpend assistant. Ask me about budget, voting, projects, or how the platform works.</div>
        </div>
        <div style="padding:12px; display:flex; gap:8px; border-top:1px solid #e2e8f0;">
            <input id="chatInput" type="text" placeholder="Ask about budget, voting, projects..." style="flex:1; padding:10px; border-radius:10px; border:1px solid #e2e8f0;" onkeypress="if(event.key === 'Enter') sendChat()">
            <button class="btn btn-primary" style="padding:10px 14px; border-radius:10px;" onclick="sendChat()">Send</button>
        </div>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-grid">
        <div>
            <h3 class="logo" style="color:white; margin-bottom: 1.5rem;">CivicSpend</h3>
            <p style="font-size: 0.9rem; color: #94a3b8; line-height: 1.6;">Making municipal finance accessible, understandable, and actionable for every citizen.</p>
        </div>
        <div>
            <h4>Project Links</h4>
            <ul>
                <li><a href="#">Audit Documentation</a></li>
                <li><a href="#">City Data API</a></li>
                <li><a href="#">Privacy Policy</a></li>
            </ul>
        </div>
        <div>
            <h4>Contact Us</h4>
            <ul>
                <li>üìß support@civicspend.gov</li>
                <li>üìç Finance Dept, City Hall</li>
                <li>üìû +91 44 2345 6789</li>
            </ul>
        </div>
        <div>
            <h4>Quick Links</h4>
            <ul>
                <li><a href="#dashboard">Dashboard</a></li>
                <li><a href="#vote">Vote Now</a></li>
                <li><a href="#projects">Project Map</a></li>
                <li><a href="#how-it-works">How It Works</a></li>
            </ul>
        </div>
    </div>
    <div class="footer-bottom">
        ¬© 2026 CivicSpend Pro. All rights reserved. Built with Firebase & Google Charts.
    </div>
</footer>

<script>
    // ========== SIMPLE FIXED NAVIGATION ==========
    
    // Global variables
    let currentUser = null;
    let isAdmin = false;
    let currentLanguage = 'en';
    let mapMarkers = [];
    let map = null;
    let sliders = {};

    // SIMPLE SCROLLING FIX - Works 100%
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Setting up navigation...');
        
        // 1. Fix ALL navigation links
        document.querySelectorAll('a[href^="#"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                const sectionId = href.substring(1);
                
                console.log('Clicked:', sectionId);
                
                // Handle admin link
                if (sectionId === 'admin' && isAdmin) {
                    document.getElementById('adminDashboard').style.display = 'block';
                    document.getElementById('vote').scrollIntoView({behavior: 'smooth'});
                    return;
                }
                
                // Find and scroll to section
                const target = document.getElementById(sectionId);
                if (target) {
                    window.scrollTo({
                        top: target.offsetTop - 80,
                        behavior: 'smooth'
                    });
                }
            });
        });
        
        // 2. Fix language selector
        document.getElementById('languageSelect').addEventListener('change', function() {
            changeLanguage();
        });
        
        // 3. Fix accordion
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                content.classList.toggle('active');
                this.lastElementChild.textContent = content.classList.contains('active') ? '‚àí' : '+';
            });
        });
        
        console.log('Navigation ready!');
    });

    // ENTRY MODAL HANDLING
    window.chooseEntry = function(type) {
        document.getElementById('entryUserActions').style.display = 'none';
        document.getElementById('entryAdminActions').style.display = 'none';
        
        if (type === 'user') {
            document.getElementById('entryUserActions').style.display = 'block';
        } else if (type === 'admin') {
            document.getElementById('entryAdminActions').style.display = 'block';
        }
    };

    window.closeEntryModal = function() {
        document.getElementById('entryModal').classList.remove('show');
        setTimeout(() => {
            document.getElementById('entryModal').style.display = 'none';
        }, 400);
    };

    // VERY IMPORTANT: Guest mode
    window.enterAsGuest = function() {
        currentUser = null;
        isAdmin = false;
        
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isAdmin');
        
        closeEntryModal();
        updateUI();
        loadPublicStats();
        
        console.log("‚Üí Guest mode activated");
    };

    // MODAL CONTROLS
    window.openLoginModal = function() {
        document.getElementById('loginModal').style.display = 'block';
        setTimeout(() => {
            document.getElementById('loginModal').classList.add('show');
        }, 10);
    };
    
    window.closeLoginModal = function() {
        document.getElementById('loginModal').classList.remove('show');
        setTimeout(() => {
            document.getElementById('loginModal').style.display = 'none';
        }, 400);
    };
    
    window.openAdminLogin = function() {
        document.getElementById('adminLoginModal').style.display = 'block';
        setTimeout(() => {
            document.getElementById('adminLoginModal').classList.add('show');
        }, 10);
    };
    
    window.closeAdminLoginModal = function() {
        document.getElementById('adminLoginModal').classList.remove('show');
        setTimeout(() => {
            document.getElementById('adminLoginModal').style.display = 'none';
        }, 400);
    };

    // SEND OTP FUNCTION
    window.sendOTP = function() {
        const phoneNumber = document.getElementById('phoneNumber').value;
        
        if (!phoneNumber || phoneNumber.length < 10) {
            alert('Please enter a valid phone number');
            return;
        }
        
        // Simulate OTP sending
        document.getElementById('userLoginForm').style.display = 'none';
        document.getElementById('otpContainer').style.display = 'block';
        alert('Demo: OTP sent to ' + phoneNumber + '\nUse 123456 as OTP');
    };

    // USER LOGIN SUCCESS PATH
    window.verifyOTP = async function() {
        const otp = document.getElementById('verificationCode').value;
        
        if (otp === '123456') {
            const phone = document.getElementById('phoneNumber').value || '+919876543210';
            
            currentUser = {
                uid: 'user-' + Date.now(),
                phoneNumber: phone,
                displayName: 'Demo User'
            };
            isAdmin = false;
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('isAdmin', 'false');
            
            // Close ALL modals
            closeLoginModal();
            closeEntryModal();
            
            updateUI();
            checkUserVote();
            loadPublicStats();
            
            alert('‚úÖ Successfully logged in as User!');
        } else {
            alert('‚ùå Wrong OTP (demo uses 123456)');
        }
    };

    // ADMIN LOGIN SUCCESS PATH
    window.adminLogin = function() {
        const email = document.getElementById('adminEmail').value.trim() || 'admin@example.com';
        
        currentUser = {
            uid: 'admin-' + Date.now(),
            email: email,
            displayName: 'Administrator'
        };
        isAdmin = true;
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('isAdmin', 'true');
        
        // Close both modals
        closeAdminLoginModal();
        closeEntryModal();
        
        updateUI();
        loadAdminStats();
        
        alert('‚úÖ Admin login successful!');
    };

    // LOGOUT
    window.logout = function() {
        currentUser = null;
        isAdmin = false;
        
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isAdmin');
        
        updateUI();
        loadPublicStats();
        
        // Show entry modal again after logout
        document.getElementById('entryModal').style.display = 'block';
        setTimeout(() => {
            document.getElementById('entryModal').classList.add('show');
        }, 10);
    };

    // UPDATE UI
    function updateUI() {
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userStatus = document.getElementById('userStatus');
        const adminLink = document.getElementById('adminLink');
        
        // Check localStorage for saved login
        const savedUser = localStorage.getItem('currentUser');
        const savedAdmin = localStorage.getItem('isAdmin');
        
        if (savedUser && !currentUser) {
            currentUser = JSON.parse(savedUser);
            isAdmin = savedAdmin === 'true';
        }
        
        if (currentUser) {
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            userStatus.style.display = 'inline';
            
            if (isAdmin) {
                userStatus.innerHTML = `<span class="admin-badge">ADMIN</span> ${currentUser.email || 'Admin'}`;
                adminLink.style.display = 'inline';
                document.getElementById('adminDashboard').style.display = 'block';
                
                // Hide voting interface for admin
                document.getElementById('login_prompt').style.display = 'none';
                document.getElementById('voting_controls').style.display = 'none';
                document.getElementById('already_voted').style.display = 'none';
                
                // Load admin stats
                loadAdminStats();
            } else {
                userStatus.innerHTML = `üë§ ${currentUser.phoneNumber || 'User'}`;
                adminLink.style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'none';
                
                // Check if user has voted
                checkUserVote();
            }
        } else {
            // Guest or not logged in
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            userStatus.style.display = 'none';
            adminLink.style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            
            // Show login prompt in vote card
            document.getElementById('login_prompt').style.display = 'block';
            document.getElementById('voting_controls').style.display = 'none';
            document.getElementById('already_voted').style.display = 'none';
        }
    }
    
    // CHECK USER VOTE
    function checkUserVote() {
        if (!currentUser || isAdmin) return;
        
        // Check localStorage for demo votes
        const userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
        const hasVoted = userVotes[currentUser.uid];
        
        if (hasVoted) {
            document.getElementById('already_voted').style.display = 'block';
            document.getElementById('voting_controls').style.display = 'none';
            document.getElementById('login_prompt').style.display = 'none';
            
            // Show user's previous vote values
            const voteData = userVotes[currentUser.uid];
            document.getElementById('user_welcome').innerText = `Verified: ${currentUser.phoneNumber || 'User'} | Your previous vote recorded`;
        } else {
            document.getElementById('user_welcome').innerText = "Verified: " + (currentUser.phoneNumber || 'User');
            document.getElementById('login_prompt').style.display = 'none';
            document.getElementById('voting_controls').style.display = 'block';
            document.getElementById('already_voted').style.display = 'none';
            
            // Initialize sliders with default values
            initializeSliders();
        }
    }
    
    // FIX: VOTE SLIDER MANAGEMENT SYSTEM
    function initializeSliders() {
        // Store slider references
        sliders = {
            edu: document.getElementById('edu_p'),
            infra: document.getElementById('inf_p'),
            health: document.getElementById('health_p'),
            san: document.getElementById('san_p')
        };
        
        // Initialize all to 25%
        Object.values(sliders).forEach(slider => {
            if (slider) slider.value = 25;
        });
        
        // Update display values
        updateSliderValue('val1', 25);
        updateSliderValue('val2', 25);
        updateSliderValue('val3', 25);
        updateSliderValue('val4', 25);
        
        // Add event listeners for dynamic adjustment
        Object.values(sliders).forEach(slider => {
            if (slider) {
                slider.addEventListener('input', function() {
                    adjustOtherSliders(this.id, parseInt(this.value));
                });
            }
        });
    }
    
    // FIX: DYNAMIC SLIDER ADJUSTMENT
    function adjustOtherSliders(changedId, newValue) {
        const sliderIds = ['edu_p', 'inf_p', 'health_p', 'san_p'];
        const changedIndex = sliderIds.indexOf(changedId);
        
        if (changedIndex === -1) return;
        
        // Calculate total of other sliders
        let otherTotal = 0;
        for (let i = 0; i < sliderIds.length; i++) {
            if (i !== changedIndex) {
                otherTotal += parseInt(sliders[sliderIds[i].split('_')[0]].value);
            }
        }
        
        // Calculate remaining percentage
        const remaining = 100 - newValue;
        
        // If other sliders exceed remaining, adjust them proportionally
        if (otherTotal > remaining) {
            const scaleFactor = remaining / otherTotal;
            
            for (let i = 0; i < sliderIds.length; i++) {
                if (i !== changedIndex) {
                    const slider = sliders[sliderIds[i].split('_')[0]];
                    const newSliderValue = Math.round(parseInt(slider.value) * scaleFactor);
                    slider.value = newSliderValue;
                    
                    // Update display
                    const displayId = 'val' + (i + 1);
                    updateSliderValue(displayId, newSliderValue);
                }
            }
        }
        
        // Update total display
        updateTotalDisplay();
    }
    
    // FIX: UPDATE SLIDER VALUE DISPLAY
    window.updateSliderValue = function(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value + '%';
            updateTotalDisplay();
        }
    };
    
    // FIX: UPDATE TOTAL DISPLAY
    function updateTotalDisplay() {
        if (!sliders.edu || !sliders.infra || !sliders.health || !sliders.san) return;
        
        const total = parseInt(sliders.edu.value) + parseInt(sliders.infra.value) + 
                     parseInt(sliders.health.value) + parseInt(sliders.san.value);
        
        const totalElement = document.getElementById('totalPercent');
        if (totalElement) {
            totalElement.textContent = total + '%';
            
            // Color code the total
            if (total === 100) {
                totalElement.style.color = '#10b981';
                totalElement.innerHTML = '100% ‚úì';
            } else if (total < 100) {
                totalElement.style.color = '#f59e0b';
                totalElement.innerHTML = total + '% (Add ' + (100 - total) + '%)';
            } else {
                totalElement.style.color = '#ef4444';
                totalElement.innerHTML = total + '% (Reduce ' + (total - 100) + '%)';
            }
        }
    }
    
    // SEND FEEDBACK (VOTE)
    window.sendFeedback = function() {
        if (!currentUser || isAdmin) {
            alert('Please login as a user to vote');
            return;
        }
        
        const gender = document.getElementById('genderSelect').value;
        const ageGroup = document.getElementById('ageGroupSelect').value;
        const ward = document.getElementById('wardSelect').value;
        
        if (!gender || !ageGroup || !ward) {
            alert('Please select gender, age group, and ward');
            return;
        }
        
        // Check if total is 100%
        const eduVal = parseInt(document.getElementById('edu_p').value);
        const infraVal = parseInt(document.getElementById('inf_p').value);
        const healthVal = parseInt(document.getElementById('health_p').value);
        const sanVal = parseInt(document.getElementById('san_p').value);
        const total = eduVal + infraVal + healthVal + sanVal;
        
        if (total !== 100) {
            alert(`Total must be exactly 100%. Currently: ${total}%. Please adjust your priorities.`);
            return;
        }
        
        const voteData = {
            uid: currentUser.uid,
            phone: currentUser.phoneNumber || 'Not provided',
            gender: gender,
            ageGroup: ageGroup,
            ward: ward,
            edu: eduVal,
            infra: infraVal,
            health: healthVal,
            san: sanVal,
            reason: document.getElementById('voteReason').value || 'No reason provided',
            followUpdates: document.getElementById('followUpdates').checked,
            timestamp: Date.now(),
            date: new Date().toISOString().split('T')[0]
        };
        
        // Store vote in localStorage
        const userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
        userVotes[currentUser.uid] = voteData;
        localStorage.setItem('userVotes', JSON.stringify(userVotes));
        
        alert('‚úÖ Vote submitted successfully! Thank you for your input.');
        checkUserVote();
        loadPublicStats();
        
        if (isAdmin) {
            loadAdminStats();
        }
    };
    
    // LOAD PUBLIC STATS
    function loadPublicStats() {
        const userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
        const votes = Object.values(userVotes);
        const today = new Date().toISOString().split('T')[0];
        
        const ageCounts = { '18-25': 0, '26-35': 0, '36-50': 0, '50+': 0 };
        const genderCounts = { 'male': 0, 'female': 0, 'other': 0 };
        let totalEdu = 0, totalInfra = 0, totalHealth = 0, totalSan = 0;
        
        votes.forEach(v => {
            if (v.ageGroup && ageCounts[v.ageGroup] !== undefined) {
                ageCounts[v.ageGroup]++;
            }
            if (v.gender && genderCounts[v.gender] !== undefined) {
                genderCounts[v.gender]++;
            }
            if (v.edu) totalEdu += parseInt(v.edu);
            if (v.infra) totalInfra += parseInt(v.infra);
            if (v.health) totalHealth += parseInt(v.health);
            if (v.san) totalSan += parseInt(v.san);
        });
        
        const todayVotes = votes.filter(v => v.date === today).length;
        
        document.getElementById('publicTotalVotes').textContent = votes.length;
        document.getElementById('publicTodayVotes').textContent = todayVotes;
        document.getElementById('publicAvgEducation').textContent = votes.length > 0 ? Math.round(totalEdu / votes.length) + '%' : '0%';
        document.getElementById('publicAvgInfra').textContent = votes.length > 0 ? Math.round(totalInfra / votes.length) + '%' : '0%';
        
        // Load charts
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => {
            const ageData = google.visualization.arrayToDataTable([
                ['Age', 'Votes'],
                ['18-25', ageCounts['18-25']],
                ['26-35', ageCounts['26-35']],
                ['36-50', ageCounts['36-50']],
                ['50+', ageCounts['50+']]
            ]);
            
            const genderData = google.visualization.arrayToDataTable([
                ['Gender', 'Votes'],
                ['Male', genderCounts['male']],
                ['Female', genderCounts['female']],
                ['Other', genderCounts['other']]
            ]);
            
            // Budget chart
            const budgetData = google.visualization.arrayToDataTable([
                ['Category', 'Amount (‚Çπ Cr)'],
                ['Education', 45],
                ['Healthcare', 32],
                ['Infrastructure', 58],
                ['Sanitation', 25]
            ]);
            
            // Year-over-year comparison
            const yearData = google.visualization.arrayToDataTable([
                ['Category', '2023', '2024'],
                ['Education', 42, 45],
                ['Healthcare', 30, 32],
                ['Infrastructure', 52, 58],
                ['Sanitation', 22, 25]
            ]);
            
            // Budget vs Actual
            const budgetActualData = google.visualization.arrayToDataTable([
                ['Category', 'Budgeted', 'Actual'],
                ['Education', 48, 45],
                ['Healthcare', 35, 32],
                ['Infrastructure', 60, 58],
                ['Sanitation', 27, 25]
            ]);
            
            // Draw charts
            if (document.getElementById('main_chart')) {
                new google.visualization.PieChart(document.getElementById('main_chart')).draw(budgetData, {
                    pieHole: 0.6,
                    chartArea: {width: '90%', height: '80%'},
                    legend: {position: 'bottom'},
                    backgroundColor: 'transparent',
                    colors: ['#2563eb', '#10b981', '#f59e0b', '#ef4444']
                });
            }
            
            if (document.getElementById('year_comparison_chart')) {
                new google.visualization.ColumnChart(document.getElementById('year_comparison_chart')).draw(yearData, {
                    title: 'Year-over-Year Comparison (‚Çπ Cr)',
                    legend: {position: 'top'},
                    backgroundColor: 'transparent',
                    colors: ['#94a3b8', '#2563eb']
                });
            }
            
            if (document.getElementById('budget_actual_chart')) {
                new google.visualization.ColumnChart(document.getElementById('budget_actual_chart')).draw(budgetActualData, {
                    title: 'Budget vs Actual Spending (‚Çπ Cr)',
                    legend: {position: 'top'},
                    backgroundColor: 'transparent',
                    colors: ['#f59e0b', '#10b981']
                });
            }
            
            if (document.getElementById('publicAgeChart')) {
                new google.visualization.ColumnChart(document.getElementById('publicAgeChart')).draw(ageData, {
                    legend: 'none',
                    backgroundColor: 'transparent',
                    colors: ['#2563eb', '#10b981', '#f59e0b', '#ef4444']
                });
            }
            
            if (document.getElementById('publicGenderChart')) {
                new google.visualization.ColumnChart(document.getElementById('publicGenderChart')).draw(genderData, {
                    legend: 'none',
                    backgroundColor: 'transparent',
                    colors: ['#2563eb', '#10b981', '#f59e0b']
                });
            }
        });
    }
    
    // LOAD ADMIN STATS
    function loadAdminStats() {
        if (!isAdmin) return;
        
        const userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
        const votes = Object.values(userVotes);
        const today = new Date().toISOString().split('T')[0];
        
        const ageCounts = { '18-25': 0, '26-35': 0, '36-50': 0, '50+': 0 };
        const genderCounts = { 'male': 0, 'female': 0, 'other': 0 };
        const wardCounts = { 'Ward 1': 0, 'Ward 2': 0, 'Ward 3': 0, 'Ward 4': 0, 'Ward 5': 0 };
        let totalEdu = 0, totalInfra = 0, totalHealth = 0, totalSan = 0;
        
        votes.forEach(v => {
            if (v.ageGroup && ageCounts[v.ageGroup] !== undefined) {
                ageCounts[v.ageGroup]++;
            }
            if (v.gender && genderCounts[v.gender] !== undefined) {
                genderCounts[v.gender]++;
            }
            if (v.ward && wardCounts[v.ward] !== undefined) {
                wardCounts[v.ward]++;
            }
            if (v.edu) totalEdu += parseInt(v.edu);
            if (v.infra) totalInfra += parseInt(v.infra);
            if (v.health) totalHealth += parseInt(v.health);
            if (v.san) totalSan += parseInt(v.san);
        });
        
        const todayVotes = votes.filter(v => v.date === today).length;
        
        if (document.getElementById('totalVotes')) document.getElementById('totalVotes').textContent = votes.length;
        if (document.getElementById('todayVotes')) document.getElementById('todayVotes').textContent = todayVotes;
        if (document.getElementById('maleVotes')) document.getElementById('maleVotes').textContent = genderCounts['male'];
        if (document.getElementById('femaleVotes')) document.getElementById('femaleVotes').textContent = genderCounts['female'];
        if (document.getElementById('ward1Votes')) document.getElementById('ward1Votes').textContent = wardCounts['Ward 1'];
        if (document.getElementById('ward2Votes')) document.getElementById('ward2Votes').textContent = wardCounts['Ward 2'];
        
        // Update average priorities
        if (votes.length > 0) {
            if (document.getElementById('avgEdu')) document.getElementById('avgEdu').textContent = Math.round(totalEdu / votes.length) + '%';
            if (document.getElementById('avgInfra')) document.getElementById('avgInfra').textContent = Math.round(totalInfra / votes.length) + '%';
            if (document.getElementById('avgHealth')) document.getElementById('avgHealth').textContent = Math.round(totalHealth / votes.length) + '%';
            if (document.getElementById('avgSan')) document.getElementById('avgSan').textContent = Math.round(totalSan / votes.length) + '%';
        }
        
        // Update recent votes list
        const recentVotesList = document.getElementById('recentVotesList');
        if (recentVotesList) {
            recentVotesList.innerHTML = '';
            
            const recentVotes = votes.slice(-10).reverse();
            recentVotes.forEach(vote => {
                const div = document.createElement('div');
                div.style.padding = '8px';
                div.style.borderBottom = '1px solid #e2e8f0';
                div.innerHTML = `
                    <strong>${vote.phone || 'Unknown'}</strong><br>
                    <small>${vote.ward || 'No ward'} | ${vote.ageGroup || 'No age'} | ${vote.gender || 'No gender'}</small><br>
                    <small>Edu: ${vote.edu}%, Infra: ${vote.infra}%, Health: ${vote.health}%, San: ${vote.san}%</small>
                `;
                recentVotesList.appendChild(div);
            });
        }
        
        // Load admin charts
        google.charts.setOnLoadCallback(() => {
            const ageData = google.visualization.arrayToDataTable([
                ['Age', 'Votes'],
                ['18-25', ageCounts['18-25']],
                ['26-35', ageCounts['26-35']],
                ['36-50', ageCounts['36-50']],
                ['50+', ageCounts['50+']]
            ]);
            
            const genderData = google.visualization.arrayToDataTable([
                ['Gender', 'Votes'],
                ['Male', genderCounts['male']],
                ['Female', genderCounts['female']],
                ['Other', genderCounts['other']]
            ]);
            
            if (document.getElementById('ageChart')) {
                new google.visualization.PieChart(document.getElementById('ageChart')).draw(ageData, {
                    title: 'Age Distribution',
                    backgroundColor: 'transparent',
                    colors: ['#2563eb', '#10b981', '#f59e0b', '#ef4444']
                });
            }
            
            if (document.getElementById('genderChart')) {
                new google.visualization.PieChart(document.getElementById('genderChart')).draw(genderData, {
                    title: 'Gender Distribution',
                    backgroundColor: 'transparent',
                    colors: ['#2563eb', '#10b981', '#f59e0b']
                });
            }
        });
    }
    
    // INITIALIZE MAP
    function initMap() {
        map = L.map('project-map').setView([12.9716, 77.5946], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add project markers
        const projects = [
            { lat: 12.9716, lng: 77.5946, title: 'Smart School Project', desc: 'New digital literacy wing', ward: 'Ward 5', status: 'completed', amount: '‚Çπ2.5 Cr' },
            { lat: 12.9816, lng: 77.5846, title: 'Metro Expansion', desc: 'New metro line construction', ward: 'Ward 3', status: 'progress', amount: '‚Çπ15 Cr' },
            { lat: 12.9616, lng: 77.6046, title: 'Waste Management Plant', desc: 'New recycling facility', ward: 'Ward 2', status: 'planned', amount: '‚Çπ8 Cr' },
            { lat: 12.9766, lng: 77.5996, title: 'Public Park Development', desc: 'Green space with solar lighting', ward: 'Ward 4', status: 'progress', amount: '‚Çπ3.2 Cr' },
            { lat: 12.9666, lng: 77.5896, title: 'Water Pipeline Upgrade', desc: '5km pipeline replacement', ward: 'Ward 1', status: 'completed', amount: '‚Çπ4.5 Cr' }
        ];
        
        projects.forEach(project => {
            let markerColor = 'blue';
            if (project.status === 'completed') markerColor = 'green';
            if (project.status === 'progress') markerColor = 'orange';
            if (project.status === 'planned') markerColor = 'gray';
            
            const marker = L.marker([project.lat, project.lng], {
                icon: L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="background:${markerColor}; width:20px; height:20px; border-radius:50%; border:2px solid white;"></div>`
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <b>${project.title}</b><br>
                ${project.desc}<br>
                <strong>Ward:</strong> ${project.ward}<br>
                <strong>Status:</strong> ${project.status}<br>
                <strong>Budget:</strong> ${project.amount}<br>
                <button onclick="reportIssue('${project.title}')" style="margin-top:5px; padding:5px 10px; background:var(--danger); color:white; border:none; border-radius:4px; cursor:pointer;">
                    Report Issue
                </button>
            `);
            
            mapMarkers.push({ marker, project });
        });
    }
    
    window.filterMapByWard = function() {
        const ward = document.getElementById('wardFilter').value;
        mapMarkers.forEach(item => {
            if (ward === 'all' || item.project.ward.includes(ward)) {
                item.marker.addTo(map);
            } else {
                map.removeLayer(item.marker);
            }
        });
    };
    
    window.filterMapByStatus = function() {
        const status = document.getElementById('statusFilter').value;
        mapMarkers.forEach(item => {
            if (status === 'all' || item.project.status === status) {
                item.marker.addTo(map);
            } else {
                map.removeLayer(item.marker);
            }
        });
    };
    
    window.reportIssue = function(projectTitle) {
        if (!currentUser) {
            alert('Please login to report an issue');
            return;
        }
        const issue = prompt(`Describe the issue with ${projectTitle}:`);
        if (issue) {
            alert('Thank you! Your report has been submitted.');
        }
    };
    
    // LOAD LEDGER DATA
    function loadLedgerData() {
        const tbody = document.getElementById('ledgerBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Demo data
        const demoData = [
            ['2026-01-14', 'Education', 'Smart School Project', '‚Çπ2,50,00,000', 'Ward 5', 'ABC Constructions', 'Completed'],
            ['2026-01-13', 'Healthcare', 'Primary Health Center', '‚Çπ1,80,00,000', 'Ward 7', 'MediCare Builders', 'In Progress'],
            ['2026-01-12', 'Infrastructure', 'Road Widening', '‚Çπ3,20,00,000', 'Ward 3', 'Roads India Ltd', 'Completed'],
            ['2026-01-11', 'Sanitation', 'Sewage Treatment Plant', '‚Çπ4,50,00,000', 'Ward 9', 'CleanWater Tech', 'Planned']
        ];
        
        demoData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
                <td>${row[4]}</td>
                <td>${row[5]}</td>
                <td><span style="padding:4px 8px; border-radius:4px; background:#dcfce7; color:#166534; font-size:0.8rem;">${row[6]}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    // UTILITY FUNCTIONS
    window.downloadCSV = function() {
        const csv = 'Date,Category,Description,Amount,Ward,Vendor,Status\n' +
                   '2026-01-14,Education,Smart School Project,25000000,Ward 5,ABC Constructions,Completed\n' +
                   '2026-01-13,Healthcare,Primary Health Center,18000000,Ward 7,MediCare Builders,In Progress\n' +
                   '2026-01-12,Infrastructure,Road Widening,32000000,Ward 3,Roads India Ltd,Completed\n' +
                   '2026-01-11,Sanitation,Sewage Treatment Plant,45000000,Ward 9,CleanWater Tech,Planned';
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'civicspend_ledger.csv';
        a.click();
    };
    
    window.downloadJSON = function() {
        const data = {
            ledger: [
                { date: '2026-01-14', category: 'Education', description: 'Smart School Project', amount: 25000000, ward: 'Ward 5', vendor: 'ABC Constructions', status: 'Completed' },
                { date: '2026-01-13', category: 'Healthcare', description: 'Primary Health Center', amount: 18000000, ward: 'Ward 7', vendor: 'MediCare Builders', status: 'In Progress' },
                { date: '2026-01-12', category: 'Infrastructure', description: 'Road Widening', amount: 32000000, ward: 'Ward 3', vendor: 'Roads India Ltd', status: 'Completed' },
                { date: '2026-01-11', category: 'Sanitation', description: 'Sewage Treatment Plant', amount: 45000000, ward: 'Ward 9', vendor: 'CleanWater Tech', status: 'Planned' }
            ]
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'civicspend_data.json';
        a.click();
    };
    
    window.downloadPDF = function() {
        alert('PDF report would be generated and downloaded. This is a demo feature.');
    };
    
    window.exportVoteData = function() {
        const userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
        const votes = Object.values(userVotes);
        
        const csv = 'Phone,Gender,Age Group,Ward,Education,Infrastructure,Healthcare,Sanitation,Reason,Date\n' +
                   votes.map(v => 
                       `"${v.phone || ''}","${v.gender || ''}","${v.ageGroup || ''}","${v.ward || ''}",${v.edu || 0},${v.infra || 0},${v.health || 0},${v.san || 0},"${(v.reason || '').replace(/"/g, '""')}","${v.date || ''}"`
                   ).join('\n');
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'vote_data_export.csv';
        a.click();
    };
    
    // TRANSLATION SYSTEM
    const I18N = {
        en: {
            heroTitle: "Government Spending, <br><span style='color:var(--brand)'>Decoded for You.</span>",
            heroSubtitle: "CivicSpend Pro bridges the gap between complex municipal ledgers and citizen understanding. Explore live data, track every rupee, and influence the city's future.",
            chartTitle: "Current Resource Allocation",
            voteTitle: "Voice Your Priorities",
            publicStatsTitle: "Live Voting Stats",
            publicStatsDesc: "Aggregated stats only (no personal details).",
            publicTotalVotesLabel: "Total votes",
            publicTodayVotesLabel: "Votes today",
            publicAvgEducationLabel: "Avg Education",
            publicAvgInfraLabel: "Avg Infrastructure",
            publicAgeTitle: "Age groups",
            publicGenderTitle: "Gender",
            projectsTitle: "Infrastructure Projects Map",
            projectsSubtitle: "Click on markers to see project details and report issues.",
            howTitle: "How CivicSpend Works",
            faqTitle: "Common Questions",
            loginPromptText: "Verify your identity via SMS to vote.",
            votedTitle: "Identity Verified",
            votedSubtitle: "Your vote is securely recorded against your phone number.",
            yearCompareTitle: "Year-over-Year Comparison",
            budgetActualTitle: "Budget vs Actual Spending",
            faq1: "Where does this data come from?",
            faq1a: "Our data is fetched from the Open Data portal of the Municipal Corporation. It is updated once the quarterly audits are finalized.",
            faq2: "How secure is my vote?",
            faq2a: "Votes are cryptographically signed and stored against your verified phone number. No personal data is shown publicly.",
            faq3: "Can I change my vote?",
            faq3a: "One vote per verified number per budget cycle. Contact support@civicspend.gov for special circumstances.",
            faq4: "Is this official government site?",
            faq4a: "CivicSpend Pro is a civic-tech initiative approved by the City Finance Department for transparency.",
            faq5: "How often is data updated?",
            faq5a: "Financial data is updated every 24 hours. Project status updates are real-time as reported by field officers.",
            faq6: "Who can see my vote?",
            faq6a: "Only aggregated anonymous statistics are shown publicly. Individual votes are visible only to authorized administrators for analysis.",
            eduLabel: "Education",
            infLabel: "Infrastructure",
            healthLabel: "Healthcare",
            sanLabel: "Sanitation",
            step1Title: "Data Ingestion",
            step1Desc: "Our backend connects directly to the Municipal Financial Management System (MFMS), pulling raw expenditure data every 24 hours.",
            step2Title: "Visualization",
            step2Desc: "Complex spreadsheets are converted into intuitive charts using Google Charts API, making it easy for citizens to spot trends and anomalies.",
            step3Title: "Public Feedback",
            step3Desc: "Citizens use the priority sliders to 'vote' on where they want future funds to go. This data is stored on Google Firebase for public audit.",
            chartDesc: "This chart represents the <strong>validated treasury data</strong> for the fiscal year 2024-25. Data is pulled directly from the municipal accounting API and updated in real-time as warrants are issued."
        },
        ta: {
            heroTitle: "‡ÆÖ‡Æ∞‡Æö‡ØÅ ‡Æö‡ØÜ‡Æ≤‡Æµ‡ØÅ, <br><span style='color:var(--brand)'>‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ.</span>",
            heroSubtitle: "CivicSpend Pro ‡Æ®‡Æï‡Æ∞‡Ææ‡Æü‡Øç‡Æö‡Æø ‡Æï‡Æ£‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øà ‡Æé‡Æ≥‡Æø‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ. ‡Æ§‡Æ∞‡Æµ‡Øà‡Æ™‡Øç ‡Æ™‡Ææ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡Æö‡ØÜ‡Æ≤‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÅ‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Øä‡Æ≥‡Øç‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.",
            chartTitle: "‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ ‡Æ®‡Æø‡Æ§‡Æø ‡Æí‡Æ§‡ØÅ‡Æï‡Øç‡Æï‡ØÄ‡Æü‡ØÅ",
            voteTitle: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà‡ÆØ‡Øà ‡Æ§‡ØÜ‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç",
            publicStatsTitle: "‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ ‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æø‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç",
            publicStatsDesc: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æø‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç (‡Æ§‡Æ©‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà).",
            publicTotalVotesLabel: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç",
            publicTodayVotesLabel: "‡Æá‡Æ©‡Øç‡Æ±‡Øà‡ÆØ ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç",
            publicAvgEducationLabel: "‡Æö‡Æ∞‡Ææ‡Æö‡Æ∞‡Æø ‡Æï‡Æ≤‡Øç‡Æµ‡Æø",
            publicAvgInfraLabel: "‡Æö‡Æ∞‡Ææ‡Æö‡Æ∞‡Æø ‡Æâ‡Æ≥‡Øç‡Æï‡Æü‡Øç‡Æü‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ",
            publicAgeTitle: "‡Æµ‡ÆØ‡Æ§‡ØÅ ‡Æï‡ØÅ‡Æ¥‡ØÅ‡Æï‡Øç‡Æï‡Æ≥‡Øç",
            publicGenderTitle: "‡Æ™‡Ææ‡Æ≤‡Æø‡Æ©‡ÆÆ‡Øç",
            projectsTitle: "‡ÆÆ‡ØÜ‡ÆØ‡Øç‡ÆØ ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà ‡Æµ‡Øá‡Æ≤‡Øà ‡ÆÖ‡Æü‡Øç‡Æü‡Æµ‡Æ£‡Øà",
            projectsSubtitle: "‡ÆÆ‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ∞‡Øç‡Æï‡Æ≥‡Øà ‡Æï‡Æø‡Æ≥‡Æø‡Æï‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æ™‡Ææ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.",
            howTitle: "CivicSpend ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æµ‡Øá‡Æ≤‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ",
            faqTitle: "‡Æ™‡Øä‡Æ§‡ØÅ‡Æµ‡Ææ‡Æ© ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øç",
            loginPromptText: "SMS ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æü‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ§‡Øç‡Æ§‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
            votedTitle: "‡ÆÖ‡Æü‡Øà‡ÆØ‡Ææ‡Æ≥‡ÆÆ‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ",
            votedSubtitle: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Øä‡Æ≤‡Øà‡Æ™‡Øá‡Æö‡Æø ‡Æé‡Æ£‡Øç‡Æ£‡Æø‡Æ≤‡Øç ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡Ææ‡Æï ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æ§‡ØÅ.",
            eduLabel: "‡Æï‡Æ≤‡Øç‡Æµ‡Æø",
            infLabel: "‡Æâ‡Æ≥‡Øç‡Æï‡Æü‡Øç‡Æü‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ",
            healthLabel: "‡Æö‡ØÅ‡Æï‡Ææ‡Æ§‡Ææ‡Æ∞‡ÆÆ‡Øç",
            sanLabel: "‡Æö‡ØÅ‡Æï‡Ææ‡Æ§‡Ææ‡Æ∞‡ÆÆ‡Øç",
            step1Title: "‡Æü‡Øá‡Æü‡Øç‡Æü‡Ææ ‡Æá‡Æ©‡Øç‡Æú‡ØÜ‡Æ∏‡Øç‡Æö‡Æ©‡Øç",
            step1Desc: "‡Æé‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Øá‡Æï‡Øç‡Æé‡Æ£‡Øç‡Æü‡Øç MFMS ‡Æâ‡Æü‡Æ©‡Øç ‡Æ®‡Øá‡Æ∞‡Æü‡Æø‡ÆØ‡Ææ‡Æï ‡Æá‡Æ£‡Øà‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æ§‡ØÅ, 24 ‡ÆÆ‡Æ£‡Æø‡Æ®‡Øá‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æí‡Æ∞‡ØÅ‡ÆÆ‡ØÅ‡Æ±‡Øà ‡Æü‡Øá‡Æü‡Øç‡Æü‡Ææ ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.",
            step2Title: "‡Æµ‡Æø‡Æö‡ØÅ‡Æµ‡Æ≤‡Æø‡Æö‡Øá‡Æ∑‡Æ©‡Øç",
            step2Desc: "‡Æé‡Æ≥‡Æø‡Æ§‡Ææ‡Æ© ‡Æö‡Ææ‡Æ∞‡Øç‡Æü‡Øç‡Æü‡ØÅ‡Æï‡Æ≥‡Ææ‡Æï ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡ØÅ ‡Æü‡Øá‡Æü‡Øç‡Æü‡Ææ ‡Æï‡Ææ‡Æü‡Øç‡Æö‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.",
            step3Title: "‡Æ™‡Æ™‡Øç‡Æ≥‡Æø‡Æï‡Øç ‡ÆÉ‡Æ™‡ØÄ‡Æü‡Øç‡Æ™‡Øá‡Æï‡Øç",
            step3Desc: "‡Æï‡ØÅ‡Æü‡Æø‡ÆÆ‡Æï‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà‡Æï‡Æ≥‡Øà ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ≥‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç.",
            chartDesc: "‡Æá‡Æ®‡Øç‡Æ§ ‡Æö‡Ææ‡Æ∞‡Øç‡Æü‡Øç 2024-25 ‡Æ®‡Æø‡Æ§‡Æø‡ÆØ‡Ææ‡Æ£‡Øç‡Æü‡Æø‡Æ±‡Øç‡Æï‡Ææ‡Æ© ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æü‡Øá‡Æü‡Øç‡Æü‡Ææ‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ."
        },
        hi: {
            heroTitle: "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§ñ‡§∞‡•ç‡§ö, <br><span style='color:var(--brand)'>‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§∞‡§≤.</span>",
            heroSubtitle: "CivicSpend Pro ‡§ú‡§ü‡§ø‡§≤ ‡§®‡§ó‡§∞‡§™‡§æ‡§≤‡§ø‡§ï‡§æ ‡§≤‡•á‡§ú‡§∞ ‡§ï‡•ã ‡§Ü‡§∏‡§æ‡§® ‡§¨‡§®‡§æ‡§§‡§æ ‡§π‡•à‡•§ ‡§°‡•á‡§ü‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç, ‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§Æ‡§ù‡•á‡§Ç‡•§",
            chartTitle: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§Ü‡§µ‡§Ç‡§ü‡§®",
            voteTitle: "‡§Ö‡§™‡§®‡•Ä ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ‡§è‡§Å ‡§¨‡§§‡§æ‡§è‡§Ç",
            publicStatsTitle: "‡§≤‡§æ‡§á‡§µ ‡§µ‡•ã‡§ü ‡§Ü‡§Å‡§ï‡§°‡§º‡•á",
            publicStatsDesc: "‡§ï‡•á‡§µ‡§≤ ‡§∏‡§Æ‡•á‡§ï‡§ø‡§§ ‡§Ü‡§Å‡§ï‡§°‡§º‡•á (‡§ï‡•ã‡§à ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§®‡§π‡•Ä‡§Ç).",
            publicTotalVotesLabel: "‡§ï‡•Å‡§≤ ‡§µ‡•ã‡§ü",
            publicTodayVotesLabel: "‡§Ü‡§ú ‡§ï‡•á ‡§µ‡•ã‡§ü",
            publicAvgEducationLabel: "‡§î‡§∏‡§§ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ",
            publicAvgInfraLabel: "‡§î‡§∏‡§§ ‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§¢‡§æ‡§Ç‡§ö‡§æ",
            publicAgeTitle: "‡§Ü‡§Ø‡•Å ‡§∏‡§Æ‡•Ç‡§π",
            publicGenderTitle: "‡§≤‡§ø‡§Ç‡§ó",
            projectsTitle: "‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§¢‡§æ‡§Ç‡§ö‡§æ ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å",
            projectsSubtitle: "‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§",
            howTitle: "CivicSpend ‡§ï‡•à‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à",
            faqTitle: "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®",
            loginPromptText: "‡§µ‡•ã‡§ü ‡§¶‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡•Ä ‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§",
            votedTitle: "‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§",
            votedSubtitle: "‡§Ü‡§™‡§ï‡§æ ‡§µ‡•ã‡§ü ‡§Ü‡§™‡§ï‡•á ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§",
            eduLabel: "‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ",
            infLabel: "‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§¢‡§æ‡§Ç‡§ö‡§æ",
            healthLabel: "‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ",
            sanLabel: "‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§§‡§æ",
            step1Title: "‡§°‡•á‡§ü‡§æ ‡§á‡§®‡•ç‡§ó‡•á‡§∏‡•ç‡§ü‡§®",
            step1Desc: "‡§π‡§Æ‡§æ‡§∞‡§æ ‡§¨‡•à‡§ï‡§è‡§Ç‡§° MFMS ‡§∏‡•á ‡§∏‡•Ä‡§ß‡•á ‡§ú‡•Å‡§°‡§º‡§§‡§æ ‡§π‡•à, 24 ‡§ò‡§Ç‡§ü‡•á ‡§Æ‡•á‡§Ç ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§§‡§æ ‡§π‡•à‡•§",
            step2Title: "‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡•á‡§∂‡§®",
            step2Desc: "‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§",
            step3Title: "‡§ú‡§®‡§§‡§æ ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ",
            step3Desc: "‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§µ‡•ã‡§ü ‡§¶‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§",
            chartDesc: "‡§Ø‡§π ‡§ö‡§æ‡§∞‡•ç‡§ü 2024-25 ‡§ï‡•á ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§°‡•á‡§ü‡§æ ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à‡•§"
        }
    };
    
    window.changeLanguage = function() {
        currentLanguage = document.getElementById('languageSelect').value;
        applyLanguage(currentLanguage);
    };
    
    function applyLanguage(lang) {
        const t = I18N[lang] || I18N.en;
        
        // Update all text elements
        const elementsToTranslate = [
            'heroTitle', 'heroSubtitle', 'chartTitle', 'voteTitle', 'publicStatsTitle', 
            'publicStatsDesc', 'publicTotalVotesLabel', 'publicTodayVotesLabel',
            'publicAvgEducationLabel', 'publicAvgInfraLabel', 'publicAgeTitle', 
            'publicGenderTitle', 'projectsTitle', 'projectsSubtitle', 'howTitle', 
            'faqTitle', 'loginPromptText', 'votedTitle', 'votedSubtitle',
            'yearCompareTitle', 'budgetActualTitle', 'eduLabel', 'infLabel',
            'healthLabel', 'sanLabel', 'faq1', 'faq1a', 'faq2', 'faq2a',
            'faq3', 'faq3a', 'faq4', 'faq4a', 'faq5', 'faq5a', 'faq6', 'faq6a',
            'step1Title', 'step1Desc', 'step2Title', 'step2Desc', 'step3Title', 'step3Desc',
            'chartDesc'
        ];
        
        elementsToTranslate.forEach(id => {
            const el = document.getElementById(id);
            if (el && t[id]) {
                if (id === 'heroTitle' || id === 'chartDesc') {
                    el.innerHTML = t[id];
                } else {
                    el.textContent = t[id];
                }
            }
        });
    }
    
    // CHATBOT FUNCTIONS
    window.toggleChatbot = function() {
        const panel = document.getElementById('chatbotPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    };
    
    window.sendChat = function() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        const chatMessages = document.getElementById('chatMessages');
        
        // Add user message
        chatMessages.innerHTML += `<div style="margin-bottom:10px;"><strong>You:</strong> ${message}</div>`;
        input.value = '';
        
        // Generate bot response
        const response = generateBotResponse(message);
        
        // Add bot response after a short delay
        setTimeout(() => {
            chatMessages.innerHTML += `<div style="margin-bottom:10px; background:#eff6ff; padding:10px; border-radius:8px;"><strong>Bot:</strong> ${response}</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 500);
    };
    
    function generateBotResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        if (lowerMessage.includes('budget') || lowerMessage.includes('spending') || lowerMessage.includes('money')) {
            return "The current annual budget is ‚Çπ160 Cr allocated across Education (28%), Healthcare (20%), Infrastructure (36%), and Sanitation (16%). You can see the detailed breakdown in the main chart and download the data.";
        } else if (lowerMessage.includes('vote') || lowerMessage.includes('voting') || lowerMessage.includes('priority')) {
            return "You can vote on budget priorities by logging in with your phone number. Select your gender, age group, ward, and use sliders to allocate percentages to Education, Infrastructure, Healthcare, and Sanitation. Total must equal 100%.";
        } else if (lowerMessage.includes('project') || lowerMessage.includes('map') || lowerMessage.includes('location')) {
            return "Check the Infrastructure Projects Map section to see active projects in your city. You can filter by ward and status. Click on markers for details and to report issues.";
        } else if (lowerMessage.includes('login') || lowerMessage.includes('sign in') || lowerMessage.includes('register')) {
            return "Users: Enter phone number and use '123456' as OTP. Admins: Use any email and password to login as admin.";
        } else if (lowerMessage.includes('admin') || lowerMessage.includes('dashboard')) {
            return "Admin dashboard shows voting statistics, demographic breakdowns, ward-wise distribution, and recent votes. Login as admin with any email/password to access.";
        } else if (lowerMessage.includes('slider') || lowerMessage.includes('adjust') || lowerMessage.includes('percentage')) {
            return "When you adjust one slider, the other sliders automatically adjust to keep the total at 100%. This ensures your vote percentages add up correctly.";
        } else if (lowerMessage.includes('data') || lowerMessage.includes('source') || lowerMessage.includes('where')) {
            return "Data comes from the Municipal Financial Management System (MFMS) and is updated every 24 hours. All data is validated and audited quarterly.";
        } else if (lowerMessage.includes('help') || lowerMessage.includes('how') || lowerMessage.includes('what')) {
            return "I can help with: 1) Budget information 2) Voting process 3) Project locations 4) Login help 5) Data sources 6) Language change 7) Download data.";
        } else if (lowerMessage.includes('language') || lowerMessage.includes('‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç') || lowerMessage.includes('‡§π‡§ø‡§Ç‡§¶‡•Ä')) {
            return "You can change the website language using the dropdown in the navigation bar. We support English, Tamil, and Hindi.";
        } else if (lowerMessage.includes('download') || lowerMessage.includes('export') || lowerMessage.includes('csv')) {
            return "You can download data in CSV, JSON, or PDF format using the download buttons below the charts.";
        } else if (lowerMessage.includes('ward') || lowerMessage.includes('area') || lowerMessage.includes('location')) {
            return "You can filter projects by ward using the dropdown in the map section. Also, select your ward when voting to get ward-specific insights.";
        } else if (lowerMessage.includes('report') || lowerMessage.includes('issue') || lowerMessage.includes('problem')) {
            return "To report an issue with a project, click on the marker on the map and then click 'Report Issue' button. You need to be logged in.";
        } else if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
            return "Hello! I'm your CivicSpend assistant. How can I help you today?";
        } else if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) {
            return "You're welcome! Is there anything else I can help you with?";
        } else {
            return "I understand you're asking about '" + message + "'. For specific help with budget, voting, projects, or login issues, please ask more specifically or check the FAQ section.";
        }
    }
    
    // INITIALIZE ON LOAD
    window.addEventListener('load', function() {
        // Give a tiny delay so transition looks nice
        setTimeout(() => {
            document.getElementById('entryModal').classList.add('show');
        }, 100);
        
        // Initialize map
        initMap();
        
        // Load data
        loadLedgerData();
        loadPublicStats();
        
        // Update UI
        updateUI();
        
        // Apply default language
        applyLanguage('en');
        
        // Update data freshness
        updateDataFreshness();
        setInterval(updateDataFreshness, 60000);
        
        // Initialize search
        const ledgerSearch = document.getElementById('ledgerSearch');
        if (ledgerSearch) {
            ledgerSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#ledgerBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
        console.log('CivicSpend Pro fully loaded!');
    });
    
    function updateDataFreshness() {
        const hours = Math.floor(Math.random() * 6);
        const element = document.getElementById('dataFreshness');
        if (element) element.textContent = `Data synced ${hours}h ago`;
    }
</script>

</body>
</html>

